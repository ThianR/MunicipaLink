<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>MunicipaLink | Gesti칩n Ciudadana</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Custom Style - Modular CSS -->
    <link rel="stylesheet" href="styles/main.css">
</head>
<body class="role-guest">
    <!-- Login Screen -->
    <div id="screen-login" class="screen screen--active login-screen">
        <div class="login-container">
            <!-- Left Panel: Info & Motivation -->
            <div class="login-panel-info">
                <div class="login-panel-info__content">
                    <div class="login-logo-wrapper">
                        <i data-lucide="map-pin" class="login-logo-icon"></i>
                        <span class="login-logo-text">MunicipaLink</span>
                    </div>
                    <div class="login-motivation">
                        <h2 class="login-motivation-title">Juntos construimos el futuro</h2>
                        <p class="login-motivation-text">
                            Tu participaci칩n es el motor que transforma nuestra comunidad. Al registrar tus solicitudes y colaborar con tus vecinos, construyes un municipio m치s unido y pr칩spero. La indiferencia nos detiene, pero tu compromiso nos impulsa a seguir adelante.
                        </p>
                    </div>
                    <div class="login-features">
                        <div class="feature-item">
                            <i data-lucide="users"></i>
                            <span>Comunidad Unida</span>
                        </div>
                        <div class="feature-item">
                            <i data-lucide="message-circle"></i>
                            <span>Comunicaci칩n Directa</span>
                        </div>
                        <div class="feature-item">
                            <i data-lucide="shield-check"></i>
                            <span>Acci칩n Solidaria</span>
                        </div>
                    </div>
                </div>
                <div class="login-decoration"></div>
            </div>

            <!-- Right Panel: Form -->
            <div class="login-panel-form">
                <div class="login-card">
                    <div class="mobile-logo">
                        <i data-lucide="map-pin" style="width: 40px; height: 40px; color: #10b981;"></i>
                        <h1 class="login-card__title">MunicipaLink</h1>
                    </div>
                    
                    <div class="form-header">
                        <h2 class="form-title">Bienvenido</h2>
                        <p class="form-subtitle">Inicia sesi칩n para continuar con tus gestiones</p>
                    </div>

                    <form id="form-auth" class="auth-form">
                        <div class="form-group">
                            <label class="input-label">Correo Electr칩nico</label>
                            <input type="email" id="auth-email" placeholder="ejemplo@correo.com" required class="input">
                        </div>
                        <div class="form-group">
                            <label class="input-label">Contrase침a</label>
                            <input type="password" id="auth-password" placeholder="********" required class="input">
                        </div>
                        <div class="auth-actions">
                            <button type="submit" id="btn-login" class="button button--primary">Iniciar Sesi칩n</button>
                            <button type="button" id="btn-signup" class="button button--secondary">쯅o tienes cuenta? Reg칤strate</button>
                        </div>
                    </form>

                    <button id="btn-forgot-password" class="btn-forgot">
                        쯆lvidaste tu contrase침a?
                    </button>

                    <div class="divider"><span>o continuar con</span></div>

                    <div class="social-login">
                        <button id="btn-login-google" class="button button--google">
                            <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" width="20" alt="G">
                            Google
                        </button>
                    </div>

                    <div class="guest-login">
                        <button id="btn-login-guest" class="btn-guest">Entrar como Invitado</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- App Screen -->
    <div id="screen-app" class="screen">
        <header class="header">
            <div class="header__logo">
                <i data-lucide="map-pin"></i>
                <h1 class="header__logo-title">MunicipaLink</h1>
            </div>
            <div class="header__user-info">
                <span id="user-display" class="header__user-name">Invitado</span>
                <button id="btn-logout" class="btn-guest">Cerrar Sesi칩n</button>
            </div>
        </header>

        <div class="app-content">
            <!-- Left Sidebar -->
            <aside class="sidebar">
                <!-- Sidebar Map Controls -->
                <div class="sidebar__controls">
                    <button id="btn-recenter" class="button--map-tool" title="Centrar en Municipalidad">
                        <i data-lucide="refresh-cw"></i>
                    </button>
                    <button id="btn-locate" class="button--map-tool" title="Mi Ubicaci칩n">
                        <i data-lucide="navigation"></i>
                    </button>
                </div>

                <section>
                    <label style="font-weight: 700; display: block; margin-bottom: 0.5rem; font-size: 0.875rem;">MUNICIPALIDAD</label>
                    <select id="muni-selector" class="muni-selector">
                        <option value="">Detectando...</option>
                    </select>
                </section>

                <nav class="sidebar__nav" style="margin-top: 1.5rem;">
                    <button class="nav__item nav__item--active" data-view="map">
                        <i data-lucide="map"></i> Explorar Mapa
                    </button>
                    <button class="nav__item" data-view="reports">
                        <i data-lucide="list"></i> Solicitudes
                    </button>
                    <button class="nav__item" data-view="profile">
                        <i data-lucide="user"></i> Mi Perfil
                    </button>
                </nav>

                <div id="admin-panel" class="admin-only" style="margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem;">
                    <h3 style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">ADMIN PANEL</h3>
                    <button id="btn-admin-panel" class="button button--action" style="background: #374151;">Gestionar Municipalidades</button>
                </div>

                <div style="margin-top: auto;">
                    <button id="btn-open-report" class="button button--action role-restricted">
                        <i data-lucide="plus"></i> Nuevo Reporte
                    </button>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="content-view">
                <!-- Map View -->
                <div id="view-map" class="view view--active" style="position: relative;">
                    <div id="map"></div>
                    
                    <!-- Floating Map Controls (Mobile/Visual) -->
                    <div class="floating-map-tools">
                        <select id="muni-selector-map" class="muni-selector-compact">
                            <option value="">Cargando...</option>
                        </select>
                        <div class="map-action-group">
                            <button id="btn-recenter-map" class="btn-map-float" title="Centrar">
                                <i data-lucide="refresh-cw"></i>
                            </button>
                            <button id="btn-locate-map" class="btn-map-float" title="Mi Ubicaci칩n">
                                <i data-lucide="navigation"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Reports History View -->
                <div id="view-reports" class="view">
                    <div class="view-header reports__header">
                        <div class="header-title">
                            <h2>Solicitudes</h2>
                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Gesti칩n de reportes.</p>
                        </div>
                        
                        <div class="reports-controls-container">
                            <!-- Mobile Toggle Button -->
                            <button id="btn-toggle-filters" class="mobile-filter-toggle">
                                <i data-lucide="filter"></i> Filtros
                            </button>

                            <!-- Collapsible Toolbar -->
                             <div id="reports-toolbar" class="reports__toolbar">
                                <div class="search reports__search">
                                    <i data-lucide="search" class="search__icon"></i>
                                    <input type="text" id="search-input" placeholder="Buscar ID o descripci칩n..." class="search__input">
                                </div>
                                <select id="sort-selector" class="select reports__select">
                                    <option value="recent">M치s Recientes</option>
                                    <option value="oldest">M치s Antiguos</option>
                                    <option value="impact">M치s Relevantes</option>
                                </select>
                                <select id="muni-selector-reports" class="select reports__select">
                                    <option value="">Municipio: Todos</option>
                                </select>
                                <select id="status-selector-reports" class="select reports__select">
                                    <option value="">Estado: Todos</option>
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="En proceso">En proceso</option>
                                    <option value="Resuelto">Resuelto</option>
                                    <option value="Rechazado">Rechazado</option>
                                </select>
                                <button id="btn-clear-filters" class="button--clear" title="Limpiar filtros">
                                    <i data-lucide="x-circle"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Tab Navigation (Mobile Only) -->
                    <div class="reports-controls-mobile">
                        <div class="tabs">
                            <button class="tabs__button role-restricted" data-tab="my-requests">
                                <i data-lucide="user"></i> Mis Solicitudes
                            </button>
                            <button class="tabs__button tabs__button--active" data-tab="all-requests">
                                <i data-lucide="globe"></i> Todas las Solicitudes
                            </button>
                        </div>
                    </div>

                    <!-- Tab Content: My Requests -->
                    <div id="tab-my-requests" class="tab-content tabs__content">
                        <div id="my-reports-list" class="reports-list">
                            <!-- Items will be rendered here -->
                            <div class="empty-state">
                                <i data-lucide="clipboard-list"></i>
                                <p>A칰n no has enviado ning칰n reporte.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: All Requests -->
                    <div id="tab-all-requests" class="tab-content tabs__content tabs__content--active">
                        <div class="filter-info">
                            <i data-lucide="filter"></i>
                            <span id="filter-status">Mostrando todas las solicitudes</span>
                        </div>
                        <div id="all-reports-list" class="reports-list">
                            <!-- Items will be rendered here -->
                            <div class="empty-state">
                                <i data-lucide="inbox"></i>
                                <p>No hay solicitudes para mostrar.</p>
                            </div>
                        </div>
                    </div>
                </div>
            <!-- View: Report Detail (Full Screen Form) -->
    <div id="view-report-detail" class="view detail-view">
        <div class="detail-view__header">
            <button id="btn-back-detail" class="button button--back">
                <i data-lucide="arrow-left"></i> Volver a solicitudes
            </button>
            <h2 id="detail-title">Detalle de Solicitud</h2>
        </div>

        <div class="detail-view__content">
            <div class="detail-view__grid">
                <!-- Left Column: Map & Info -->
                <div class="detail-view__left">
                    <div class="detail-view__map-container">
                        <div id="detail-map" class="detail-view__map"></div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-card__meta">
                            <span id="detail-category" class="status-badge">Categor칤a</span>
                            <span id="detail-status" class="status-badge">Estado</span>
                            <span id="detail-date" class="detail-card__date">Fecha</span>
                            <div id="detail-priority" class="report-card__priority priority-stars"></div>
                        </div>
                        <h3 class="detail-card__title">Descripci칩n</h3>
                        <p id="detail-description" class="detail-card__description"></p>
                    </div>
                </div>

                <!-- Right Column: Evidence & Interaction -->
                <div class="detail-view__right">
                    <!-- Evidence Carousel -->
                    <div class="detail-card">
                        <h3 class="detail-card__title"><i data-lucide="image"></i> Evidencias</h3>
                        <div id="evidences-carousel" class="evidences-carousel">
                            <!-- Images rendered here -->
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="detail-card">
                        <div class="detail-actions">
                            <button id="btn-vote-up" class="button button--secondary role-restricted" data-vote="voto_positivo">
                                <i data-lucide="thumbs-up"></i>
                                <span id="vote-up-count">0</span>
                            </button>
                            <button id="btn-vote-down" class="button button--secondary role-restricted" data-vote="voto_negativo">
                                <i data-lucide="thumbs-down"></i>
                                <span id="vote-down-count">0</span>
                            </button>
                            <button id="btn-follow" class="button button--primary role-restricted">
                                <i data-lucide="eye"></i> Seguir
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2" style="font-size: 0.75rem; margin-top: 0.5rem; display: block;">
                            <i data-lucide="info" style="width: 12px; height: 12px; vertical-align: middle;"></i>
                            Tus interacciones ayudan a priorizar este reporte.
                        </small>
                    </div>

                    <!-- Comments -->
                    <div class="detail-card">
                        <h3 class="detail-card__title"><i data-lucide="message-circle"></i> Comentarios (<span id="comments-count">0</span>)</h3>
                        <div id="comments-list" class="comments-list">
                            <!-- Comments rendered here -->
                        </div>
                        
                        <form id="form-add-comment" class="add-comment-form role-restricted">
                            <textarea id="comment-content" class="input" placeholder="Escribe un comentario..." required rows="3"></textarea>
                            <button type="submit" class="button button--primary">Enviar Comentario</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- View: Admin Panel -->
    <div id="view-admin" class="view">
        <div class="view-header">
            <button id="btn-back-admin" class="btn-back">
                <i data-lucide="arrow-left"></i> Volver al Mapa
            </button>
            <h2><i data-lucide="shield"></i> Panel de Administraci칩n</h2>
        </div>

        <div class="admin-container">
            <div class="admin-sidebar">
                <button class="admin-tab-btn active" data-admin-tab="dashboard">
                    <i data-lucide="layout-dashboard"></i> Dashboard
                </button>
                <button class="admin-tab-btn" data-admin-tab="municipalities">
                    <i data-lucide="building-2"></i> Municipalidades
                </button>
                <button class="admin-tab-btn" data-admin-tab="users">
                    <i data-lucide="users"></i> Usuarios
                </button>
            </div>

            <div class="admin-content">
                <!-- Dashboard Tab -->
                <div id="admin-tab-dashboard" class="admin-content-pane active">
                    <div class="admin-stats-grid">
                        <div class="stat-card">
                            <h3>Usuarios Totales</h3>
                            <p class="stat-number" id="admin-total-users">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Reportes Activos</h3>
                            <p class="stat-number" id="admin-active-reports">0</p>
                        </div>
                        <div class="stat-card">
                            <h3>Municipalidades</h3>
                            <p class="stat-number" id="admin-total-munis">0</p>
                        </div>
                    </div>
                </div>

                <!-- Municipalities Tab -->
                <div id="admin-tab-municipalities" class="admin-content-pane">
                    <div class="toolbar-premium">
                        <div class="search-premium">
                            <input type="text" id="admin-muni-search-input" placeholder="Buscar municipalidad...">
                        </div>
                        <button id="btn-new-muni" class="button button--primary btn-admin-add">
                            <i data-lucide="plus"></i> Nueva Municipalidad
                        </button>
                    </div>
                    <div class="table-container-premium">
                        <div class="table-wrapper-scroll">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="admin-munis-list">
                                <!-- JS populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>

                <!-- Users Tab -->
                <div id="admin-tab-users" class="admin-content-pane">
                    <div class="toolbar-premium">
                        <div class="search-premium">
                            <input type="text" id="admin-users-search-input" placeholder="Buscar usuario (nombre, email, ID)...">
                        </div>
                        <div class="admin-stats-mini">
                            <span>Total: <strong id="stat-total-users">0</strong></span>
                            <span>Admin: <strong id="stat-admin-users">0</strong></span>
                            <span>Muni: <strong id="stat-municipal-users">0</strong></span>
                            <span>Ciudadanos: <strong id="stat-citizen-users">0</strong></span>
                        </div>
                    </div>
                    <div class="table-container-premium">
                        <div class="table-wrapper-scroll">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>ID</th>
                                        <th>Rol</th>
                                        <th>Nivel</th>
                                        <th>Ingreso</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-users-list">
                                    <!-- JS populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
            </main>
        </div>

        <!-- Mobile Navigation -->
        <nav class="nav--mobile">
            <button class="nav__item nav__item--active" data-view="map">
                <i data-lucide="map"></i>
                <span>Mapa</span>
            </button>
            <button class="nav__item" data-view="reports">
                <i data-lucide="list"></i>
                <span>Solicitudes</span>
            </button>
            <button class="nav__item" data-view="profile">
                <i data-lucide="user"></i>
                <span>Perfil</span>
            </button>
        </nav>

        <!-- Mobile FAB -->
        <button id="btn-open-report-mobile" class="fab">
            <i data-lucide="plus"></i>
        </button>

        <!-- View: User Profile -->
        <div id="view-profile" class="view">
            <div class="view-header">
                <button id="btn-back-profile" class="btn-back">
                    <i data-lucide="arrow-left"></i> Volver al Mapa
                </button>
                <h2><i data-lucide="award"></i> Mi Perfil y Rango</h2>
            </div>
            
            <div class="profile-container">
                <div class="profile-sidebar">
                    <div class="profile-avatar-section">
                        <div id="profile-avatar-preview" class="avatar-large">
                            <i data-lucide="user"></i>
                        </div>
                        <input type="file" id="input-avatar" accept="image/*" style="display: none;">
                        <button type="button" class="btn-guest" onclick="document.getElementById('input-avatar').click()">
                            Cambiar Foto
                        </button>
                    </div>

                    <!-- Level Section -->
                    <div class="level-card">
                        <div class="level-badge" id="user-badge">游븱</div>
                        <div class="level-info">
                            <h3 id="user-rank">Vecino Novato</h3>
                            <span class="level-number">Nivel <span id="user-level-num">1</span></span>
                        </div>
                        <div class="level-progress-container">
                            <div class="level-progress-bar">
                                <div id="level-progress-fill" class="level-progress-fill" style="width: 0%;"></div>
                            </div>
                            <small id="level-xp-text">0 / 500 XP</small>
                        </div>
                        <button id="btn-open-xp-guide" class="btn-xp-guide">
                            <i data-lucide="help-circle"></i> 쮺칩mo ganar XP?
                        </button>
                    </div>

                    <div class="stats-summary-card">
                        <div class="stat-item">
                            <i data-lucide="clipboard-list" class="stat-icon"></i>
                            <span class="stat-value" id="stat-reports">0</span>
                            <span class="stat-label">Reportes</span>
                        </div>
                        <div class="stat-item">
                            <i data-lucide="message-square" class="stat-icon"></i>
                            <span class="stat-value" id="stat-comments">0</span>
                            <span class="stat-label">comentarios</span>
                        </div>
                        <div class="stat-item">
                            <i data-lucide="thumbs-up" class="stat-icon"></i>
                            <span class="stat-value" id="stat-votes">0</span>
                            <span class="stat-label">votos</span>
                        </div>
                        <div class="stat-item">
                            <i data-lucide="users" class="stat-icon"></i>
                            <span class="stat-value" id="stat-followers">0</span>
                            <span class="stat-label">seguidores</span>
                        </div>
                        <div class="stat-item">
                            <i data-lucide="user-plus" class="stat-icon"></i>
                            <span class="stat-value" id="stat-following">0</span>
                            <span class="stat-label">siguiendo</span>
                        </div>
                    </div>

                    <button id="btn-my-history" class="btn-guest" style="width:100%; margin-top:0.5rem;">
                        <i data-lucide="history"></i> Mi Historial de Reportes
                    </button>

                    <div class="trust-meter-card">
                        <div class="trust-meter-header">
                            <span class="trust-label">Nivel de Impacto</span>
                            <span id="trust-multiplier" class="trust-value">1.0x</span>
                        </div>
                        <div class="trust-progress-bg">
                            <div id="trust-progress-fill" class="trust-progress-fill" style="width: 0%;"></div>
                        </div>
                        <p class="trust-hint">Completa tu perfil para que tus reportes tengan hasta el <strong>doble de prioridad</strong>.</p>
                    </div>
                </div>

                <div class="profile-main">
                    <!-- Mensaje para Invitados -->
                    <div id="guest-welcome-message" class="guest-welcome-card" style="display: none;">
                        <div class="guest-msg-content">
                            <i data-lucide="sparkles" class="guest-msg-icon"></i>
                            <h3>춰칔nete a nuestra comunidad!</h3>
                            <p>Est치s navegando como <strong>invitado</strong>. Para poder reportar problemas, votar solicitudes y ganar puntos de impacto, necesitas una cuenta.</p>
                            <p class="guest-msg-quote">"Peque침as acciones ciudadanas logran grandes cambios en nuestra ciudad. 춰Registrate hoy y s칠 parte del cambio!"</p>
                            <button onclick="location.reload()" class="btn-action" style="margin-top: 1.5rem;">Ir a Inicio de Sesi칩n</button>
                        </div>
                    </div>

                    <form id="form-profile" class="card-premium">
                        <div class="form-grid-premium">
                            <div class="form-group">
                                <label>Nombre de Usuario (Alias)</label>
                                <div class="input-with-icon">
                                    <i data-lucide="at-sign"></i>
                                    <input type="text" name="alias" class="input" placeholder="@usuario">
                                </div>
                            </div>
                            <div class="form-group private-field">
                                <label>Nombre Completo</label>
                                <div class="input-with-icon">
                                    <i data-lucide="user"></i>
                                    <input type="text" name="nombre_completo" class="input" placeholder="Tu nombre">
                                </div>
                            </div>
                            <div class="form-group private-field">
                                <label>Fecha de Nacimiento</label>
                                <div class="input-with-icon">
                                    <i data-lucide="calendar"></i>
                                    <input type="date" name="fecha_nacimiento" class="input">
                                </div>
                                <small id="display-age" class="text-muted" style="margin-top: 0.25rem; display: block;"></small>
                            </div>
                            <div class="form-group private-field">
                                <label>G칠nero</label>
                                <div class="input-with-icon">
                                    <i data-lucide="user-check"></i>
                                    <select name="genero" class="input">
                                        <option value="">Seleccionar...</option>
                                        <option value="Masculino">Masculino</option>
                                        <option value="Femenino">Femenino</option>
                                        <option value="Otro">Otro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group private-field">
                                <label>Contacto / WhatsApp</label>
                                <div class="input-with-icon">
                                    <i data-lucide="phone"></i>
                                    <input type="text" name="contacto" class="input" placeholder="+595 ...">
                                </div>
                            </div>
                            <div class="form-group private-field">
                                <label>Direcci칩n F칤sica</label>
                                <div class="input-with-icon">
                                    <i data-lucide="map-pin"></i>
                                    <input type="text" name="direccion" class="input" placeholder="Barrio, Ciudad...">
                                </div>
                            </div>
                        </div>
                        <div class="form-footer">
                            <button type="submit" id="btn-save-profile" class="button button--action" style="width: 100%;">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    </div>


    <!-- Modals -->
    <div id="modal-report" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Nuevo Reporte</h2>
                <button id="btn-close-modal" class="btn-close">&times;</button>
            </div>
            <form id="form-report" class="card-premium">
                <div class="form-group">
                    <label>Categor칤a</label>
                    <div class="input-with-icon">
                        <i data-lucide="tag"></i>
                        <select name="category_id" id="report-category" class="input" required>
                            <option value="">Cargando categor칤as...</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Descripci칩n</label>
                    <div class="input-with-icon">
                        <i data-lucide="message-square" style="top: 0.75rem; transform: none;"></i>
                        <textarea name="description" id="report-description" class="input" style="min-height: 120px; padding-top: 0.75rem !important;" placeholder="Describe el problema aqu칤..." required></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label>Fotos (M치x. 3)</label>
                    <div class="file-upload-container">
                        <input type="file" id="report-photos" name="photos" accept="image/*" multiple class="muni-selector">
                        <small class="text-muted">Puedes seleccionar m칰ltiples fotos o tomar fotos con tu c치mara.</small>
                        <small class="text-muted">M치ximo 3 archivos, cada uno con un tama침o m치ximo de 30MB.</small>
                    </div>
                </div>
                <div class="form-group" style="display: flex; gap: 1rem; align-items: center; background: #f9fafb; padding: 1rem; border-radius: 8px;">
                    <i data-lucide="map-pin" style="color: var(--primary);"></i>
                    <span id="report-coords" style="font-size: 0.875rem; color: var(--text-muted);">Capturando ubicaci칩n...</span>
                </div>
                
                <div class="form-group" style="margin-top: 1rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                    <input type="checkbox" id="terms-check" required style="margin-top: 0.25rem;">
                    <label for="terms-check" style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.3;">
                        Acepto los t칠rminos y condiciones. Entiendo que subir contenido falso, documentos inv치lidos o censurables puede resultar en el <strong>baneo permanente</strong> de mi cuenta.
                    </label>
                </div>

                <button type="submit" id="btn-submit-report" class="button button--action">Enviar Reporte</button>
            </form>
        </div>
    </div>

    <!-- Modal: Request Password Reset -->
    <div id="modal-reset-request" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Recuperar Contrase침a</h2>
                <button id="btn-close-reset-request" class="btn-close">&times;</button>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Ingresa tu correo electr칩nico y te enviaremos un enlace para restablecer tu contrase침a.
            </p>
            <form id="form-reset-request">
                <div class="form-group">
                    <label>Correo Electr칩nico</label>
                    <input type="email" id="reset-email" class="muni-selector" placeholder="tu@email.com" required>
                </div>
                <button type="submit" class="btn-action">Enviar Enlace de Recuperaci칩n</button>
            </form>
        </div>
    </div>

    </div>

    <!-- Modal: XP Guide -->
    <div id="modal-xp-guide" class="modal">
        <div class="modal__content modal-xp">
            <div class="modal__header">
                <h2><i data-lucide="award"></i> Gu칤a de Experiencia</h2>
                <button id="btn-close-xp-guide" class="btn-close">&times;</button>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem; text-align: center;">
                Gana puntos de experiencia (XP) participando activamente en tu comunidad
            </p>
            <div class="xp-rewards-grid">
                <div class="xp-reward-item">
                    <div class="xp-icon" style="background: #dbeafe; color: #2563eb;">
                        <i data-lucide="edit-3"></i>
                    </div>
                    <div class="xp-info">
                        <span class="xp-action">Reportar Problema</span>
                        <span class="xp-value">+50 XP</span>
                    </div>
                </div>
                <div class="xp-reward-item">
                    <div class="xp-icon" style="background: #e0e7ff; color: #6366f1;">
                        <i data-lucide="message-square"></i>
                    </div>
                    <div class="xp-info">
                        <span class="xp-action">Comentar Solicitud</span>
                        <span class="xp-value">+10 XP</span>
                    </div>
                </div>
                <div class="xp-reward-item">
                    <div class="xp-icon" style="background: #fef3c7; color: #f59e0b;">
                        <i data-lucide="thumbs-up"></i>
                    </div>
                    <div class="xp-info">
                        <span class="xp-action">Recibir Voto 칔til</span>
                        <span class="xp-value">+5 XP</span>
                    </div>
                </div>
                <div class="xp-reward-item">
                    <div class="xp-icon" style="background: #d1fae5; color: #059669;">
                        <i data-lucide="award"></i>
                    </div>
                    <div class="xp-info">
                        <span class="xp-action">Reporte Resuelto</span>
                        <span class="xp-value">+150 XP</span>
                    </div>
                </div>
            </div>
            <div class="xp-tip">
                <i data-lucide="lightbulb"></i>
                <p>Completa tu perfil y mant칠n una participaci칩n constante para subir de nivel m치s r치pido</p>
            </div>
        </div>
        </div>
    </div>

    <!-- Dynamic Modal: User Profile -->
    <div id="modal-user-profile" class="modal">
        <div class="modal__content profile-card-modal">
            <div class="modal__header">
                <h2>Perfil del Ciudadano</h2>
                <button class="button--close" onclick="document.getElementById('modal-user-profile').classList.remove('modal--active')"><i data-lucide="x"></i></button>
            </div>
            <div class="profile-card-body">
                <div class="profile-card-header">
                    <div class="profile-avatar-wrapper" id="modal-user-avatar-click">
                        <img id="modal-user-avatar" src="" alt="Avatar" class="profile-avatar-large">
                    </div>
                    <div class="profile-info-large">
                        <h3 id="modal-user-handle">@usuario</h3>
                        
                        <div class="rank-badge-container">
                            <div class="rank-icon-wrapper">
                                <i data-lucide="eye" class="rank-icon"></i>
                            </div>
                            <span id="modal-user-rank" class="rank-name">OBSERVADOR ACTIVO - NIVEL 1</span>
                        </div>
                    </div>
                </div>

                <div class="profile-stats-grid-extended">
                    <div class="stat-item-ext">
                        <span class="stat-value-ext" id="modal-user-reports">0</span>
                        <span class="stat-label-ext">REPORTES</span>
                    </div>
                    <div class="stat-item-ext">
                        <span class="stat-value-ext" id="modal-user-votes">0</span>
                        <span class="stat-label-ext">VOTOS</span>
                    </div>
                </div>

                <div class="xp-progress-section">
                    <div class="xp-progress-wrapper">
                        <div id="modal-user-xp-bar" class="xp-progress-fill-card" style="width: 0%;"></div>
                    </div>
                    <p class="xp-progress-text" id="modal-user-xp-detail">0 / 500 XP para el siguiente nivel</p>
                </div>

                <p class="profile-footer-date" id="modal-user-joined-full">Ciudadano desde el -- de -- de ----</p>

                <div class="modal-footer-actions" style="margin-top: 1.5rem;">
                    <button id="btn-view-user-reports" class="button button--orange">
                        <i data-lucide="external-link"></i> Ver sus reportes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Public Profile -->
    <div id="modal-public-profile" class="modal">
        <div class="modal__content profile-modal-compact">
            <div class="modal__header">
                <h2>Perfil del Ciudadano</h2>
                <button id="btn-close-public-profile" class="btn-close">&times;</button>
            </div>
            <div id="public-profile-content">
                <!-- Content injected via JS -->
                <div class="loading-spinner">Cargando...</div>
            </div>
        </div>
    </div>


    <!-- Modal: Update Password -->
    <div id="modal-update-password" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Nueva Contrase침a</h2>
                <button id="btn-close-update-password" class="btn-close">&times;</button>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Ingresa tu nueva contrase침a.
            </p>
            <form id="form-update-password">
                <div class="form-group">
                    <label>Nueva Contrase침a</label>
                    <input type="password" id="new-password" class="muni-selector" placeholder="M칤nimo 6 caracteres" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Confirmar Contrase침a</label>
                    <input type="password" id="confirm-password" class="muni-selector" placeholder="Repite tu contrase침a" required minlength="6">
                </div>
                <button type="submit" class="btn-action">Actualizar Contrase침a</button>
            </form>
        </div>
    </div>


    <!-- Lightbox Modal -->
    <div id="modal-lightbox" class="lightbox">
        <span id="btn-close-lightbox" class="lightbox-close">&times;</span>
        <img id="lightbox-img" class="lightbox-content">
        <a id="btn-download-img" class="lightbox-download" download>
            <i data-lucide="download"></i> Descargar
        </a>
    </div>




    <!-- Modal: Admin Municipality -->
    <div id="modal-admin-municipality" class="modal">
        <div class="modal__content modal-large">
            <div class="modal__header">
                <h2 id="modal-muni-title">Nueva Municipalidad</h2>
                <button id="btn-close-modal-muni" class="btn-close">&times;</button>
            </div>
            <div class="modal-body-split">
                <div class="modal-form-side">
                    <form id="form-muni">
                        <div class="form-group">
                            <label>Nombre de la Municipalidad</label>
                            <input type="text" id="muni-name" class="muni-selector" required>
                        </div>
                        <div class="form-group">
                            <label>Ubicaci칩n (Centro)</label>
                            <small class="text-muted">Arrastra el marcador en el mapa.</small>
                            <div class="coords-inputs">
                                <input type="text" id="muni-lat" placeholder="Latitud" readonly>
                                <input type="text" id="muni-lng" placeholder="Longitud" readonly>
                            </div>
                        </div>
                        <button type="submit" class="button button--primary" style="width: 100%; margin-top: 1rem;">
                            Guardar Municipalidad
                        </button>
                    </form>
                </div>
                <div class="modal-map-side">
                    <div id="muni-map-container" style="width: 100%; height: 100%; min-height: 300px; border-radius: 8px;"></div>
                    <div id="muni-map-loader" class="map-loader">
                        <div class="spinner"></div>
                        <p>Cargando mapa...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Admin Departments -->
    <div id="modal-admin-departments" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Departamentos de <span id="modal-dept-muni-name" class="text-primary"></span></h2>
                <button id="btn-close-modal-dept" class="btn-close">&times;</button>
            </div>
            
            <!-- New Dept Form -->
            <div class="form-header-premium">
                <h3><i data-lucide="plus-circle"></i> Nuevo Departamento</h3>
                <p class="text-muted">Agregue unidades organizativas a esta municipalidad.</p>
            </div>
            
            <form id="form-add-dept" class="card-premium">
                <div class="form-grid-premium">
                    <div class="form-group">
                        <label for="new-dept-name">Nombre del Departamento</label>
                        <div class="input-with-icon">
                            <i data-lucide="tag"></i>
                            <input type="text" id="new-dept-name" placeholder="Ej: Tesorer칤a, Obras, etc." required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="new-dept-contact">Contacto / WhatsApp</label>
                        <div class="input-with-icon">
                            <i data-lucide="phone"></i>
                            <input type="text" id="new-dept-contact" placeholder="+595 ...">
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="button button--primary btn-admin-add">
                        <span id="btn-submit-dept-text"><i data-lucide="save"></i> Guardar Departamento</span>
                    </button>
                </div>
            </form>

            <div class="admin-dept-divider">
                <span>Listado de Departamentos</span>
            </div>

            <div class="toolbar-premium">
                <div class="search-premium">
                    <input type="text" id="admin-dept-search-input" placeholder="Buscar departamento...">
                </div>
            </div>

            <div class="table-container-premium">
                <div class="table-wrapper-scroll" style="max-height: 350px;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Contacto</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="admin-dept-list">
                            <!-- JS populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Admin User Edit -->
    <div id="modal-admin-user" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Editar Usuario</h2>
                <button id="btn-close-modal-user" class="btn-close">&times;</button>
            </div>
            <form id="form-edit-user">
                <div class="form-group">
                    <label>Alias</label>
                    <input type="text" id="edit-user-alias" class="muni-selector">
                </div>
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" id="edit-user-fullname" class="muni-selector">
                </div>
                <div class="form-group">
                    <label>Rol</label>
                    <select id="edit-user-role" class="muni-selector">
                        <option value="ciudadano">Ciudadano</option>
                        <option value="municipal">Municipal</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nivel de Vecino</label>
                    <select id="edit-user-level" class="muni-selector">
                        <option value="Vecino Novato">Vecino Novato</option>
                        <option value="Vecino Observador">Vecino Observador</option>
                        <option value="Vecino Comprometido">Vecino Comprometido</option>
                        <option value="Vecino Experto">Vecino Experto</option>
                        <option value="L칤der Comunitario">L칤der Comunitario</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Estado de Cuenta</label>
                    <select id="edit-user-status" class="muni-selector">
                        <option value="true">Activo</option>
                        <option value="false">Baneado / Inactivo</option>
                    </select>
                </div>
                <button type="submit" class="button button--primary" style="width: 100%; margin-top: 1rem;">
                    Guardar Cambios
                </button>
            </form>
        </div>
    </div>

    <!-- Modal: Admin Reset Password -->
    <div id="modal-reset-password" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Resetear Contrase침a</h2>
                <button id="btn-close-modal-reset" class="btn-close">&times;</button>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                쮼st치s seguro que deseas enviar un correo de restablecimiento de contrase침a a <strong id="reset-user-email-display"></strong>?
            </p>
            <div class="modal-footer-actions">
                <button id="btn-cancel-reset" class="button button--secondary">Cancelar</button>
                <button id="btn-confirm-reset" class="button button--primary">Confirmar Env칤o</button>
            </div>
        </div>
    </div>

    <!-- Custom Toasts -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Main Application Script (Modular) -->
    <script type="module" src="src/modules/admin-view-connector.js"></script>
    <script type="module" src="src/main.js"></script>
</body>
</html>
