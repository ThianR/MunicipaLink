<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>MunicipaLink | Gesti贸n Ciudadana</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><path d='M256 48c-88.366 0-160 71.634-160 160 0 118.5 160 256 160 256s160-137.5 160-256 c0-88.366-71.634-160-160-160z' fill='%2310b981'/><circle cx='256' cy='208' r='110' fill='%23ffffff'/><path d='M341.0,234.3 L335.5,252.5 L333.4,270.3 L312.2,290.7 L253.6,288.3 L274.5,252.1 L270.8,244.5 L204.3,216.5 L171.0,184.4 L189.4,131.4 L243.4,125.3 L262.6,142.0 L266.1,181.3 L309.9,185.4 L318.9,219.6 L339.1,221.8 Z' fill='%2310b981'/></svg>">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS (Loaded Dynamically if needed, but kept here for critical path if map is home) -->
    <!-- Optimization: Preconnect to CDN -->
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Custom Style - Modular CSS -->
    <link rel="stylesheet" href="styles/main.css">
</head>
<body class="role-guest">
    <!-- Login Screen -->
    <div id="screen-login" class="screen screen--active login-screen">
        <div class="login-container">
            <!-- Left Panel: Info & Motivation -->
            <div class="login-panel-info">
                <div class="login-panel-info__content">
                    <div class="logo logo--large">
                        <svg class="logo-icon" viewBox="0 0 512 512">
                            <defs>
                                <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="var(--logo-green)"/>
                                    <stop offset="100%" stop-color="var(--logo-blue)"/>
                                </linearGradient>
                            </defs>
                            <path class="pin" d="M256 48c-88.366 0-160 71.634-160 160 0 118.5 160 256 160 256s160-137.5 160-256 c0-88.366-71.634-160-160-160z" fill="url(#logoGradient)"/>
                            <circle cx="256" cy="208" r="110" fill="#ffffff"/>
                            <path class="py" d="M341.0,234.3 L335.5,252.5 L333.4,270.3 L312.2,290.7 L253.6,288.3 L274.5,252.1 L270.8,244.5 L204.3,216.5 L171.0,184.4 L189.4,131.4 L243.4,125.3 L262.6,142.0 L266.1,181.3 L309.9,185.4 L318.9,219.6 L339.1,221.8 Z"/>
                        </svg>
                        <span class="login-logo-text">MunicipaLink</span>
                    </div>
                    <div class="login-motivation">
                        <h2 class="login-motivation-title">Juntos construimos el futuro</h2>
                        <p class="login-motivation-text">
                            Tu participaci贸n es el motor que transforma nuestra comunidad. Al registrar tus solicitudes y colaborar con tus vecinos, construyes un municipio m谩s unido y pr贸spero. La indiferencia nos detiene, pero tu compromiso nos impulsa a seguir adelante.
                        </p>
                    </div>
                    <div class="login-features">
                        <div class="feature-item">
                            <i data-lucide="users"></i>
                            <span>Comunidad Unida</span>
                        </div>
                        <div class="feature-item">
                            <i data-lucide="message-circle"></i>
                            <span>Comunicaci贸n Directa</span>
                        </div>
                        <div class="feature-item">
                            <i data-lucide="shield-check"></i>
                            <span>Acci贸n Solidaria</span>
                        </div>
                    </div>
                </div>
                <div class="login-decoration"></div>
            </div>

            <!-- Right Panel: Form -->
            <div class="login-panel-form">
                <div class="login-card">
                    <div class="mobile-logo logo logo--large">
                        <svg class="logo-icon" viewBox="0 0 512 512">
                            <path class="pin" d="M256 48c-88.366 0-160 71.634-160 160 0 118.5 160 256 160 256s160-137.5 160-256 c0-88.366-71.634-160-160-160z" fill="var(--primary)"/>
                            <circle cx="256" cy="208" r="110" fill="#ffffff"/>
                            <path class="py" d="M341.0,234.3 L335.5,252.5 L333.4,270.3 L312.2,290.7 L253.6,288.3 L274.5,252.1 L270.8,244.5 L204.3,216.5 L171.0,184.4 L189.4,131.4 L243.4,125.3 L262.6,142.0 L266.1,181.3 L309.9,185.4 L318.9,219.6 L339.1,221.8 Z" fill="var(--logo-green)"/>
                        </svg>
                        <span class="login-logo-text">MunicipaLink</span>
                    </div>
                    
                    <div class="form-header">
                        <h2 class="form-title">Bienvenido</h2>
                        <p class="form-subtitle">Inicia sesi贸n para continuar con tus gestiones</p>
                    </div>

                    <form id="form-auth" class="auth-form">
                        <div class="form-group">
                            <label class="input-label">Correo Electr贸nico</label>
                            <input type="email" id="auth-email" placeholder="ejemplo@correo.com" required class="input">
                        </div>
                        <div class="form-group">
                            <label class="input-label">Contrase帽a</label>
                            <input type="password" id="auth-password" placeholder="********" required class="input">
                        </div>
                        <div class="auth-actions">
                            <button type="submit" id="btn-login" class="button button--primary">Iniciar Sesi贸n</button>
                            <button type="button" id="btn-signup" class="button button--secondary">驴No tienes cuenta? Reg铆strate</button>
                        </div>
                    </form>

                    <button id="btn-forgot-password" class="btn-forgot">
                        驴Olvidaste tu contrase帽a?
                    </button>

                    <div class="divider"><span>o continuar con</span></div>

                    <div class="social-login">
                        <button id="btn-login-google" class="button button--google">
                            <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" width="20" alt="G">
                            Google
                        </button>
                    </div>

                    <div class="guest-login">
                        <button id="btn-login-guest" class="btn-guest">Entrar como Invitado</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- App Screen -->
    <div id="screen-app" class="screen">
        <header class="header">
            <div class="header__logo logo">
                <svg class="logo-icon" viewBox="0 0 512 512" style="width: 28px; height: 28px;">
                    <path class="pin" d="M256 48c-88.366 0-160 71.634-160 160 0 118.5 160 256 160 256s160-137.5 160-256 c0-88.366-71.634-160-160-160z" fill="var(--primary)"/>
                    <circle cx="256" cy="208" r="110" fill="#ffffff"/>
                    <path class="py" d="M341.0,234.3 L335.5,252.5 L333.4,270.3 L312.2,290.7 L253.6,288.3 L274.5,252.1 L270.8,244.5 L204.3,216.5 L171.0,184.4 L189.4,131.4 L243.4,125.3 L262.6,142.0 L266.1,181.3 L309.9,185.4 L318.9,219.6 L339.1,221.8 Z" fill="var(--logo-green)"/>
                </svg>
                <h1 class="header__logo-title">MunicipaLink</h1>
            </div>
            <div class="header__user-info">
                <span id="user-display" class="header__user-name">Invitado</span>
                <button id="btn-logout" class="btn-guest">Cerrar Sesi贸n</button>
            </div>
        </header>

        <div class="app-content">
            <!-- Left Sidebar -->
            <aside class="sidebar">
                <!-- Sidebar Map Controls -->
                <div class="sidebar__controls">
                    <button id="btn-recenter" class="button--map-tool" title="Centrar en Municipalidad">
                        <i data-lucide="refresh-cw"></i>
                    </button>
                    <button id="btn-locate" class="button--map-tool" title="Mi Ubicaci贸n">
                        <i data-lucide="navigation"></i>
                    </button>
                </div>

                <section>
                    <label style="font-weight: 700; display: block; margin-bottom: 0.5rem; font-size: 0.875rem;">MUNICIPALIDAD</label>
                    <select id="muni-selector" class="muni-selector">
                        <option value="">Detectando...</option>
                    </select>
                </section>

                <nav class="sidebar__nav" style="margin-top: 1.5rem;">
                    <button class="nav__item nav__item--active" data-view="map">
                        <i data-lucide="map"></i> Explorar Mapa
                    </button>
                    <button class="nav__item" data-view="reports">
                        <i data-lucide="list"></i> Solicitudes
                    </button>
                    <button class="nav__item" data-view="profile">
                        <i data-lucide="user"></i> Mi Perfil
                    </button>
                    <button class="nav__item" data-view="reporting-hub">
                        <i data-lucide="bar-chart-3"></i> Reportes
                    </button>
                    <button class="nav__item" data-view="ranking">
                        <i data-lucide="trophy"></i> Ranking
                    </button>
                    <!-- Solo visible para rol municipal -->
                    <button class="nav__item municipal-only" data-view="municipal"
                            style="display:none; background: linear-gradient(135deg, var(--primary), #059669); color:white;">
                        <i data-lucide="building-2"></i> Mi Municipalidad
                    </button>
                </nav>

                <div id="admin-panel" class="admin-only sidebar__section">
                    <span class="sidebar__label">ADMIN PANEL</span>
                    <button id="btn-admin-panel" class="nav__item nav__item--admin">
                        <i data-lucide="shield"></i> Gestionar Municipalidades
                    </button>
                </div>

                <div style="margin-top: auto;">
                    <button id="btn-open-report" class="button button--action role-restricted">
                        <i data-lucide="plus"></i> Nuevo Reporte
                    </button>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="content-view">

                <!-- ============================
                     VISTA: RANKING MUNICIPAL
                     ============================ -->
                <div id="view-ranking" class="view ranking-view">
                    <!-- Header -->
                    <div class="ranking-header">
                        <div class="ranking-header-icon">
                            <i data-lucide="trophy"></i>
                        </div>
                        <div class="ranking-header-text">
                            <h2>Ranking de Municipalidades</h2>
                            <p>Clasificaci贸n por eficiencia en resoluci贸n de reportes ciudadanos</p>
                        </div>
                    </div>
                    <!-- Lista del ranking -->
                    <div class="ranking-list" id="ranking-list">
                        <!-- Renderizado din谩micamente por ranking.js -->
                    </div>
                </div>

                <!-- Hub de Reportes Centralizado -->
                <div id="view-reporting-hub" class="view">
                    <div class="view-header" style="padding:1.5rem;">
                        <div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:0.25rem;">
                            <i data-lucide="bar-chart-3" style="width:24px;height:24px;color:var(--primary);"></i>
                            <h2 style="margin:0; font-size:1.5rem;">Centro de Reportes</h2>
                        </div>
                        <p style="margin:0; font-size:0.9rem; color:var(--text-muted);">
                            Visualiza y exporta estad铆sticas detalladas de participaci贸n y gesti贸n.
                        </p>
                    </div>
                    <div class="reporting-filters-bar" style="padding: 0 1.5rem 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
                        <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                            <label style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 0.4rem;">Fecha Inicio</label>
                            <input type="date" id="report-filter-start" class="input">
                        </div>
                        <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                            <label style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 0.4rem;">Fecha Fin</label>
                            <input type="date" id="report-filter-end" class="input">
                        </div>
                        <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                            <label style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 0.4rem;">Estado</label>
                            <select id="report-filter-status" class="select">
                                <option value="todos">Todos los estados</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="en_proceso">En Proceso</option>
                                <option value="resuelto">Resuelto</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group admin-only" style="margin-bottom: 0; flex: 1; min-width: 180px;">
                            <label style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted); display: block; margin-bottom: 0.4rem;">Municipalidad</label>
                            <select id="report-filter-muni" class="select">
                                <option value="todas">Todas las Municipalidades</option>
                            </select>
                        </div>
                    </div>

                    <div class="reporting-grid-container">
                        <!-- Categor铆a: Mis Reportes (Para todos) -->
                        <div class="reporting-section">
                            <h3 class="reporting-section-title"><i data-lucide="user"></i> Mi Actividad</h3>
                            <div class="reporting-grid" id="reports-citizen-grid">
                                <!-- Tarjetas inyectadas v铆a JS -->
                            </div>
                        </div>

                        <!-- Categor铆a: Gesti贸n Municipal (Municipal y Admin) -->
                        <div class="reporting-section municipal-only">
                            <h3 class="reporting-section-title"><i data-lucide="building-2"></i> Gesti贸n Municipal</h3>
                            <div class="reporting-grid" id="reports-municipal-grid">
                                <!-- Tarjetas inyectadas v铆a JS -->
                            </div>
                        </div>

                        <!-- Categor铆a: Administraci贸n Central (Solo Admin) -->
                        <div class="reporting-section admin-only">
                            <h3 class="reporting-section-title"><i data-lucide="shield"></i> Administraci贸n P煤blica</h3>
                            <div class="reporting-grid reporting-grid--scrollable" id="reports-admin-grid">
                                <!-- Tarjetas inyectadas v铆a JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vista Municipal: Gesti贸n de Reportes -->
                <div id="view-municipal" class="view">
                    <div class="view-header" style="padding:1.5rem 1.5rem 0;">
                    </div>

                    <!-- Navegaci贸n por Pesta帽as -->
                    <div class="tabs" style="padding: 0 1.5rem;">
                        <button class="tabs__button tabs__button--active" data-tab="muni-reportes">
                            <i data-lucide="clipboard-list"></i> Reportes
                        </button>
                        <button class="tabs__button" data-tab="muni-departamentos">
                            <i data-lucide="building"></i> Departamentos
                        </button>
                    </div>

                    <!-- Pesta帽a: Gesti贸n de Reportes -->
                    <div id="tab-muni-reportes" class="tabs__content tabs__content--active">
                        <!-- Toolbar de Filtros -->
                        <div class="toolbar-premium" style="padding: 1rem 1.5rem 0;">
                            <div style="display: flex; gap: var(--spacing-sm); align-items: flex-end; flex-wrap: wrap;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="municipal-filtro-estado">Estado</label>
                                    <select id="municipal-filtro-estado" class="select" style="min-width: 140px;">
                                        <option value="todos">Todos los Estados</option>
                                        <option value="pendiente">Pendientes</option>
                                        <option value="en_proceso">En Proceso</option>
                                        <option value="resuelto">Resueltos</option>
                                        <option value="cancelado">Cancelados</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="municipal-filtro-prioridad">Prioridad</label>
                                    <select id="municipal-filtro-prioridad" class="select" style="min-width: 140px;">
                                        <option value="todas">Todas las Prioridades</option>
                                        <option value="baja">Baja</option>
                                        <option value="media">Media</option>
                                        <option value="alta">Alta</option>
                                        <option value="urgente">Urgente</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Reportes</label>
                                    <div style="display:flex; gap: 0.5rem;">
                                        <button id="btn-muni-export-pdf" class="button button--secondary" title="Exportar PDF (Dashboard)" style="height: 42px; padding: 0 0.75rem;">
                                            <i data-lucide="file-text"></i> PDF
                                        </button>
                                        <button id="btn-muni-export-excel" class="button button--secondary" title="Exportar Excel (Planilla)" style="height: 42px; padding: 0 0.75rem;">
                                            <i data-lucide="file-spreadsheet"></i> Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de Reportes -->
                        <div class="table-container-premium" style="margin:1rem 1.5rem;">
                            <div class="table-wrapper-scroll" style="max-height: calc(100vh - 320px);">
                                <table class="table" style="width:100%;">
                                    <thead>
                                        <tr>
                                            <th>N掳 Solicitud</th>
                                            <th>Descripci贸n</th>
                                            <th>Ciudadano</th>
                                            <th>Departamento</th>
                                            <th>Estado</th>
                                            <th>Prioridad / Acci贸n</th>
                                        </tr>
                                    </thead>
                                    <tbody id="municipal-reportes-lista">
                                        <tr>
                                            <td colspan="6" style="text-align:center; padding:2rem; color:var(--text-muted);">Cargando reportes...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Pesta帽a: Gesti贸n de Departamentos -->
                    <div id="tab-muni-departamentos" class="tabs__content">
                        <div class="toolbar-premium" style="padding: 1rem 1.5rem 0;">
                            <div class="search-premium" style="flex:1; min-width: 250px;">
                            <input type="text" id="muni-dept-search" placeholder="Buscar departamento..." class="search__input" style="width: 100%;">
                        </div>
                            <button id="btn-muni-new-dept" class="button button--primary">
                                <i data-lucide="plus"></i> Nuevo Departamento
                            </button>
                        </div>

                        <div class="table-container-premium" style="margin:1rem 1.5rem;">
                            <div class="table-wrapper-scroll" style="max-height: calc(100vh - 320px);">
                                <table class="table" style="width:100%;">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Contacto</th>
                                            <th>Estado</th>
                                            <th style="text-align:right;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="muni-departamentos-lista">
                                        <tr>
                                            <td colspan="4" style="text-align:center; padding:2rem; color:var(--text-muted);">Cargando departamentos...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Map View -->
                <div id="view-map" class="view view--active" style="position: relative;">
                    <div id="map"></div>
                    
                    <!-- Mensaje para Invitados en Mapa -->
                    <div id="guest-welcome-map" class="guest-welcome-card guest-welcome-floating" style="display: none;">
                        <div class="guest-msg-content">
                            <i data-lucide="map-pin" class="guest-msg-icon"></i>
                            <h3>Explora con una cuenta</h3>
                            <p>Para reportar problemas directamente en el mapa y seguir incidencias en tiempo real, necesitas iniciar sesi贸n.</p>
                            <button onclick="location.reload()" class="button button--primary" style="margin-top: 1rem;">Iniciar Sesi贸n</button>
                        </div>
                    </div>

                    <!-- Floating Map Controls (Mobile/Visual) -->
                    <div class="floating-map-tools">
                        <select id="muni-selector-map" class="muni-selector-compact">
                            <option value="">Cargando...</option>
                        </select>
                        <div class="map-action-group">
                            <button id="btn-recenter-map" class="btn-map-float" title="Centrar">
                                <i data-lucide="refresh-cw"></i>
                            </button>
                            <button id="btn-locate-map" class="btn-map-float" title="Mi Ubicaci贸n">
                                <i data-lucide="navigation"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Reports History View -->
                <div id="view-reports" class="view">

                    <div class="view-header reports__header" id="reports-header-content">
                        <div class="header-title">
                            <h2>Solicitudes</h2>
                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Gesti贸n de reportes.</p>
                        </div>
                        
                        <div class="reports-controls-container">
                            <!-- Mobile Toggle Button -->
                            <button id="btn-toggle-filters" class="mobile-filter-toggle">
                                <i data-lucide="filter"></i> Filtros
                            </button>

                            <!-- Collapsible Toolbar -->
                             <div id="reports-toolbar" class="reports__toolbar">
                                <div class="search reports__search">
                                    <i data-lucide="search" class="search__icon"></i>
                                    <input type="text" id="search-input" placeholder="Buscar ID o descripci贸n..." class="search__input">
                                </div>
                                <select id="sort-selector" class="select reports__select">
                                    <option value="recent">M谩s Recientes</option>
                                    <option value="oldest">M谩s Antiguos</option>
                                    <option value="impact">M谩s Relevantes</option>
                                </select>
                                <select id="muni-selector-reports" class="select reports__select">
                                    <option value="">Municipio: Todos</option>
                                </select>
                                <select id="status-selector-reports" class="select reports__select">
                                    <option value="">Estado: Todos</option>
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="En proceso">En proceso</option>
                                    <option value="Resuelto">Resuelto</option>
                                    <option value="Rechazado">Rechazado</option>
                                </select>
                                <button id="btn-clear-filters" class="button--clear" title="Limpiar filtros">
                                    <i data-lucide="x-circle"></i> Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Tab Navigation (Mobile Only) -->
                    <div class="reports-controls-mobile">
                        <div class="tabs">
                            <button class="tabs__button role-restricted" data-tab="my-requests">
                                <i data-lucide="user"></i> Mis Solicitudes
                            </button>
                            <button class="tabs__button tabs__button--active" data-tab="all-requests">
                                <i data-lucide="globe"></i> Todas las Solicitudes
                            </button>
                        </div>
                    </div>

                    <!-- Tab Content: My Requests -->
                    <div id="tab-my-requests" class="tab-content tabs__content">
                        <div id="my-reports-list" class="reports-list">
                            <!-- Items will be rendered here -->
                            <div class="empty-state">
                                <i data-lucide="clipboard-list"></i>
                                <p>A煤n no has enviado ning煤n reporte.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: All Requests -->
                    <div id="tab-all-requests" class="tab-content tabs__content tabs__content--active">
                        <div class="filter-info">
                            <i data-lucide="filter"></i>
                            <span id="filter-status">Mostrando todas las solicitudes</span>
                        </div>
                        <div id="all-reports-list" class="reports-list">
                            <!-- Items will be rendered here -->
                            <div class="empty-state">
                                <i data-lucide="inbox"></i>
                                <p>No hay solicitudes para mostrar.</p>
                            </div>
                        </div>
                    </div>
                </div>
            <!-- View: Report Detail (Full Screen Form) -->
    <div id="view-report-detail" class="view detail-view">
        <div class="detail-view__header">
            <button id="btn-back-detail" class="button button--back">
                <i data-lucide="arrow-left"></i> Volver a solicitudes
            </button>
            <h2 id="detail-title">Detalle de Solicitud</h2>
        </div>

        <div class="detail-view__content">
            <div class="detail-view__grid">
                <!-- Left Column: Map & Info -->
                <div class="detail-view__left">
                    <div class="detail-view__map-container" style="position:relative;">
                        <div id="detail-map" class="detail-view__map"></div>
                        <a id="btn-navigate-gps" class="button button--primary" 
                           style="display:none; position:absolute; bottom:1.25rem; left:50%; transform:translateX(-50%); z-index:400; font-size:0.85rem; padding:0.6rem 1.25rem; border-radius:999px; align-items:center; justify-content:center; gap:0.5rem; box-shadow:0 4px 15px rgba(0,0,0,0.2); text-decoration:none; white-space:nowrap; width:max-content;" 
                           target="_blank">
                            <i data-lucide="navigation" style="width:14px;height:14px;"></i> Ir al lugar
                        </a>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-card__meta">
                            <span id="detail-category" class="status-badge">Categor铆a</span>
                            <span id="detail-status" class="status-badge">Estado</span>
                            <span id="detail-date" class="detail-card__date">Fecha</span>
                            <div id="detail-priority" class="report-card__priority priority-stars"></div>
                        </div>
                        <h3 class="detail-card__title">Descripci贸n</h3>
                        <p id="detail-description" class="detail-card__description"></p>
                    </div>

                    <!-- L铆nea de tiempo del reporte -->
                    <div id="detail-timeline-container" class="detail-card" style="display:none;">
                        <h3 class="detail-card__title"><i data-lucide="clock"></i> L铆nea de Tiempo</h3>
                        <div id="detail-timeline"></div>
                    </div>
                </div>

                <!-- Right Column: Evidence & Interaction -->
                <div class="detail-view__right">
                    <!-- Evidence Carousel -->
                    <div class="detail-card">
                        <h3 class="detail-card__title"><i data-lucide="image"></i> Evidencias</h3>
                        <div id="evidences-carousel" class="evidences-carousel">
                            <!-- Images rendered here -->
                        </div>
                    </div>

                    <!-- Evidencias de cierre (resoluci贸n / rechazo) -->
                    <div id="detail-cierre-container" class="detail-card" style="display:none;">
                        <h3 id="detail-cierre-title" class="detail-card__title"><i data-lucide="file-check"></i> Registro de Cierre</h3>
                        <div id="detail-cierre-carousel" class="evidences-carousel"></div>
                        <p id="detail-observacion" style="margin-top:0.75rem; font-size:0.875rem; color: var(--text-muted); display:none;"></p>
                    </div>

                    <!-- Actions -->
                    <div class="detail-card">
                        <div class="detail-actions">
                            <button id="btn-vote-up" class="button button--secondary role-restricted" data-vote="voto_positivo">
                                <i data-lucide="thumbs-up"></i>
                                <span id="vote-up-count">0</span>
                            </button>
                            <button id="btn-vote-down" class="button button--secondary role-restricted" data-vote="voto_negativo">
                                <i data-lucide="thumbs-down"></i>
                                <span id="vote-down-count">0</span>
                            </button>
                            <button id="btn-follow" class="button button--primary role-restricted">
                                <i data-lucide="eye"></i> Seguir
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2" style="font-size: 0.75rem; margin-top: 0.5rem; display: block;">
                            <i data-lucide="info" style="width: 12px; height: 12px; vertical-align: middle;"></i>
                            Tus interacciones ayudan a priorizar este reporte.
                        </small>
                    </div>

                    <!-- Comments -->
                    <div class="detail-card">
                        <h3 class="detail-card__title"><i data-lucide="message-circle"></i> Comentarios (<span id="comments-count">0</span>)</h3>
                        <div id="comments-list" class="comments-list">
                            <!-- Comments rendered here -->
                        </div>
                        
                        <form id="form-add-comment" class="add-comment-form role-restricted">
                            <textarea id="comment-content" class="input" placeholder="Escribe un comentario..." required rows="3"></textarea>
                            <button type="submit" class="button button--primary">Enviar Comentario</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- View: Admin Panel -->
    <div id="view-admin" class="view">
        <div class="view-header">
            <button id="btn-back-admin" class="btn-back">
                <i data-lucide="arrow-left"></i> Volver al Mapa
            </button>
            <h2><i data-lucide="shield"></i> Panel de Administraci贸n</h2>
        </div>

        <div class="admin-container">
            <div class="admin-sidebar">
                <button class="admin-tab-btn active" data-admin-tab="dashboard">
                    <div class="admin-tab-icon"><i data-lucide="layout-dashboard"></i></div>
                    <span>Dashboard</span>
                </button>
                <button class="admin-tab-btn" data-admin-tab="municipalities">
                    <div class="admin-tab-icon"><i data-lucide="building-2"></i></div>
                    <span>Municipalidades</span>
                </button>
                <button class="admin-tab-btn" data-admin-tab="users">
                    <div class="admin-tab-icon"><i data-lucide="users"></i></div>
                    <span>Usuarios</span>
                </button>
                <button class="admin-tab-btn" data-admin-tab="solicitudes">
                    <div class="admin-tab-icon"><i data-lucide="file-check"></i></div>
                    <span>Solicitudes Rol</span>
                </button>
            </div>

            <div class="admin-content">
                <!-- Dashboard Tab -->
                <div id="admin-tab-dashboard" class="admin-content-pane active">
                    <div class="admin-stats-grid">
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon"><i data-lucide="users"></i></div>
                            <div class="admin-stat-info">
                                <span class="admin-stat-label">Usuarios Totales</span>
                                <span class="admin-stat-value" id="admin-total-users">0</span>
                            </div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon"><i data-lucide="clipboard-list"></i></div>
                            <div class="admin-stat-info">
                                <span class="admin-stat-label">Reportes Activos</span>
                                <span class="admin-stat-value" id="admin-active-reports">0</span>
                            </div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-icon"><i data-lucide="building-2"></i></div>
                            <div class="admin-stat-info">
                                <span class="admin-stat-label">Municipalidades</span>
                                <span class="admin-stat-value" id="admin-total-munis">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Municipalities Tab -->
                <div id="admin-tab-municipalities" class="admin-content-pane">
                    <div class="toolbar-premium">
                    <div class="search-premium" style="flex:1;">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" id="admin-muni-search-input" placeholder="Buscar municipalidad por nombre..." class="search__input">
                    </div>
                    <button id="btn-admin-export-comparison" class="button button--secondary" title="Exportar Comparativa Municipal (Excel)">
                        <i data-lucide="bar-chart-3"></i> <span class="desktop-only">Exportar Comparativa</span>
                    </button>
                    <button id="btn-new-muni" class="button button--primary">
                        <i data-lucide="plus"></i> <span class="desktop-only">Nueva Municipalidad</span>
                    </button>
                </div>
                    <div class="table-container-premium">
                        <div class="table-wrapper-scroll">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="admin-munis-list">
                                <!-- JS populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
                </div>

                <!-- Users Tab -->
                <div id="admin-tab-users" class="admin-content-pane">
                    <div class="toolbar-premium">
                        <div class="search-premium">
                            <input type="text" id="admin-users-search-input" placeholder="Buscar usuario (nombre, email, ID)...">
                        </div>
                        <div class="admin-stats-mini">
                            <span>Total: <strong id="stat-total-users">0</strong></span>
                            <span>Admin: <strong id="stat-admin-users">0</strong></span>
                            <span>Muni: <strong id="stat-municipal-users">0</strong></span>
                            <span>Ciudadanos: <strong id="stat-citizen-users">0</strong></span>
                        </div>
                    </div>
                    <div class="table-container-premium">
                        <div class="table-wrapper-scroll">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th class="desktop-only">ID</th>
                                        <th>Rol</th>
                                        <th>Nivel</th>
                                        <th class="desktop-only">Ingreso</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-users-list">
                                    <!-- JS populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Role Requests Tab -->
                <div id="admin-tab-solicitudes" class="admin-content-pane">
                    <div class="toolbar-premium">
                        <div class="search-premium">
                            <input type="text" id="admin-solicitudes-search-input" placeholder="Buscar solicitud (nombre, muni)...">
                        </div>
                    </div>
                    <div class="table-container-premium">
                        <div class="table-wrapper-scroll">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Municipalidad</th>
                                        <th>Estado</th>
                                        <th>Detalles</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-solicitudes-list">
                                    <!-- JS populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- View: User Profile -->
    <div id="view-profile" class="view">
                    <div class="view-header">
                        <button id="btn-back-profile" class="btn-back">
                            <i data-lucide="arrow-left"></i> Volver al Mapa
                        </button>
                        <h2><i data-lucide="award"></i> Mi Perfil y Rango</h2>
                    </div>
                    
                    <div class="profile-container">
                        <div class="profile-sidebar">
                            <div class="profile-avatar-section">
                                <div id="profile-avatar-preview" class="avatar-large">
                                    <i data-lucide="user"></i>
                                </div>
                                <input type="file" id="input-avatar" accept="image/*" style="display: none;">
                                <button type="button" class="btn-guest" onclick="document.getElementById('input-avatar').click()">
                                    Cambiar Foto
                                </button>
                            </div>
        
                            <!-- Level Section -->
                            <div class="level-card">
                                <div class="level-badge" id="user-badge"></div>
                                <div class="level-info">
                                    <h3 id="user-rank">Vecino Novato</h3>
                                    <span class="level-number">Nivel <span id="user-level-num">1</span></span>
                                </div>
                                <div class="level-progress-container">
                                    <div class="level-progress-bar">
                                        <div id="level-progress-fill" class="level-progress-fill" style="width: 0%;"></div>
                                    </div>
                                    <small id="level-xp-text">0 / 500 XP</small>
                                </div>
                                <button id="btn-open-xp-guide" class="btn-xp-guide">
                                    <i data-lucide="help-circle"></i> 驴C贸mo ganar XP?
                                </button>
                            </div>
        
                            <div class="stats-summary-card">
                                <div class="stat-item">
                                    <i data-lucide="clipboard-list" class="stat-icon"></i>
                                    <span class="stat-value" id="stat-reports">0</span>
                                    <span class="stat-label">Reportes</span>
                                </div>
                                <div class="stat-item">
                                    <i data-lucide="message-square" class="stat-icon"></i>
                                    <span class="stat-value" id="stat-comments">0</span>
                                    <span class="stat-label">comentarios</span>
                                </div>
                                <div class="stat-item">
                                    <i data-lucide="thumbs-up" class="stat-icon"></i>
                                    <span class="stat-value" id="stat-votes">0</span>
                                    <span class="stat-label">votos</span>
                                </div>
                                <div class="stat-item">
                                    <i data-lucide="users" class="stat-icon"></i>
                                    <span class="stat-value" id="stat-followers">0</span>
                                    <span class="stat-label">seguidores</span>
                                </div>
                                <div class="stat-item">
                                    <i data-lucide="user-plus" class="stat-icon"></i>
                                    <span class="stat-value" id="stat-following">0</span>
                                    <span class="stat-label">siguiendo</span>
                                </div>
                            </div>
        
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                <button id="btn-citizen-export-pdf" class="button button--secondary" style="flex: 1; font-size: 0.8rem; padding: 0.6rem;">
                                    <i data-lucide="file-text"></i> Resumen PDF
                                </button>
                                <button id="btn-citizen-export-excel" class="button button--secondary" style="flex: 1; font-size: 0.8rem; padding: 0.6rem;">
                                    <i data-lucide="file-spreadsheet"></i> Historial Excel
                                </button>
                            </div>
                            
                            <button id="btn-my-history" class="btn-guest" style="width:100%; margin-top:0.5rem;">
                                <i data-lucide="history"></i> Mi Historial de Reportes
                            </button>
        
                            <div class="trust-meter-card">
                                <div class="trust-meter-header">
                                    <span class="trust-label">Nivel de Impacto</span>
                                    <span id="trust-multiplier" class="trust-value">1.0x</span>
                                </div>
                                <div class="trust-progress-bg">
                                    <div id="trust-progress-fill" class="trust-progress-fill" style="width: 0%;"></div>
                                </div>
                                <p class="trust-hint">Completa tu perfil para que tus reportes tengan hasta el <strong>doble de prioridad</strong>.</p>
                            </div>
                        </div>
        
                        <div class="profile-main">
                            <!-- Navegaci贸n por Pesta帽as -->
                            <div class="profile-tabs-nav">
                                <button class="profile-tab-btn active" data-profile-tab="personal">
                                    <i data-lucide="user"></i> Mis Datos
                                </button>
                                <button class="profile-tab-btn" data-profile-tab="municipal">
                                    <i data-lucide="building-2"></i> Solicitud Municipal
                                </button>
                            </div>
        
                            <!-- Mensaje para Invitados -->
                            <div id="guest-welcome-message" class="guest-welcome-card" style="display: none;">
                                <div class="guest-msg-content">
                                    <i data-lucide="sparkles" class="guest-msg-icon"></i>
                                    <h3>隆nete a nuestra comunidad!</h3>
                                    <p>Est谩s navegando como <strong>invitado</strong>. Para poder reportar problemas, votar solicitudes y ganar puntos de impacto, necesitas una cuenta.</p>
                                    <p class="guest-msg-quote">"Peque帽as acciones ciudadanas logran grandes cambios en nuestra ciudad. 隆Registrate hoy y s茅 parte del cambio!"</p>
                                    <button onclick="location.reload()" class="button button--primary" style="margin-top: 1.5rem;">
                                    <i data-lucide="log-in"></i> Ir a Inicio de Sesi贸n
                            </button>
                                </div>
                            </div>
        
                            <!-- Pesta帽a Datos Personales -->
                            <div id="profile-pane-personal" class="profile-tab-pane active">
                                <form id="form-profile" class="card-premium">
                                    <div class="form-grid-premium">
                                        <div class="form-group">
                                            <label>Nombre de Usuario (Alias)</label>
                                            <div class="input-with-icon">
                                                <i data-lucide="at-sign"></i>
                                                <input type="text" name="alias" class="input" placeholder="@usuario">
                                            </div>
                                        </div>
                                        <div class="form-group private-field">
                                            <label>Nombre Completo</label>
                                            <div class="input-with-icon">
                                                <i data-lucide="user"></i>
                                                <input type="text" name="nombre_completo" class="input" placeholder="Tu nombre">
                                            </div>
                                        </div>
                                        <div class="form-group private-field">
                                            <label>Fecha de Nacimiento</label>
                                            <div class="input-with-icon">
                                                <i data-lucide="calendar"></i>
                                                <input type="date" name="fecha_nacimiento" class="input">
                                            </div>
                                            <small id="display-age" class="text-muted" style="margin-top: 0.25rem; display: block;"></small>
                                        </div>
                                        <div class="form-group private-field">
                                            <label>G茅nero</label>
                                            <div class="input-with-icon">
                                                <i data-lucide="user-check"></i>
                                                <select name="genero" class="input">
                                                    <option value="">Seleccionar...</option>
                                                    <option value="Masculino">Masculino</option>
                                                    <option value="Femenino">Femenino</option>
                                                    <option value="Otro">Otro</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group private-field">
                                            <label>Contacto / WhatsApp</label>
                                            <div class="input-with-icon">
                                                <i data-lucide="phone"></i>
                                                <input type="text" name="contacto" class="input" placeholder="+595 ...">
                                            </div>
                                        </div>
                                        <div class="form-group private-field">
                                            <label>Direcci贸n F铆sica</label>
                                            <div class="input-with-icon">
                                                <i data-lucide="map-pin"></i>
                                                <input type="text" name="direccion" class="input" placeholder="Barrio, Ciudad...">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-footer">
                                        <button type="submit" id="btn-save-profile" class="button button--action" style="width: 100%;">Guardar Cambios</button>
                                    </div>
                                </form>
                            </div>
        
                            <!-- Pesta帽a Solicitud Municipal -->
                            <div id="profile-pane-municipal" class="profile-tab-pane">
                                <!-- Contenedor de Estado (Pendiente, Aprobado, Rechazado) -->
                                <div id="municipal-status-container"></div>
        
                                <!-- Formulario de Solicitud -->
                                <div id="municipal-request-form-container">
                                    <div id="municipal-request-section" class="card-premium" style="border-top: 3px solid var(--primary);">
                                        <div class="section-header-premium">
                                            <i data-lucide="building-2"></i>
                                            <h3>Solicitud de Usuario Municipal</h3>
                                        </div>
                                        <p class="text-muted" style="margin-bottom: 1.5rem;">
                                            Si eres funcionario de una municipalidad, puedes solicitar acceso para gestionar los reportes de tu zona. Necesitar谩s subir una prueba de tu cargo (identificaci贸n o decreto).
                                        </p>
                                        
                                        <form id="form-municipal-request">
                                            <div class="form-grid-premium">
                                                <div class="form-group">
                                                    <label>Municipalidad</label>
                                                    <div class="input-with-icon">
                                                        <i data-lucide="map"></i>
                                                        <select name="municipalidad_id" id="request-muni-selector" class="input" required>
                                                            <option value="">Seleccionar Municipalidad...</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label>Documento de Verificaci贸n</label>
                                                    <div class="input-with-icon">
                                                        <i data-lucide="file-text"></i>
                                                        <input type="file" id="request-document" name="document" accept="image/*,.pdf" class="input" required>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group" style="margin-top: 1rem;">
                                                <label>Comentarios adicionales (Opcional)</label>
                                                <textarea name="comentarios" class="input" style="min-height: 80px;" placeholder="Explica brevemente tu cargo o 谩rea..."></textarea>
                                            </div>
                                            <div class="form-footer" style="margin-top: 1.5rem;">
                                                <button type="submit" id="btn-submit-request" class="button button--primary" style="width: 100%;">
                                                    <i data-lucide="send"></i> Enviar Solicitud de Rol
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- .profile-main -->
                    </div>
                </div>
            </main>
        </div>

        <!-- Mobile Navigation -->
        <nav class="nav--mobile">
            <button class="nav__item nav__item--active" data-view="map">
                <i data-lucide="map"></i>
                <span>Mapa</span>
            </button>
            <button class="nav__item" data-view="reports">
                <i data-lucide="list"></i>
                <span>Solicitudes</span>
            </button>
            <button class="nav__item" data-view="reporting-hub">
                <i data-lucide="bar-chart-3"></i>
                <span>Reportes</span>
            </button>
            <button class="nav__item" data-view="profile">
                <i data-lucide="user"></i>
                <span>Perfil</span>
            </button>
            <button class="nav__item municipal-only" data-view="municipal">
                <i data-lucide="building-2"></i>
                <span>Muni</span>
            </button>
        </nav>

        <!-- Mobile FAB -->
        <button id="btn-open-report-mobile" class="fab">
            <i data-lucide="plus"></i>
        </button>

        <!-- Modals -->
        <div id="modal-report" class="modal">
            <div class="modal__content">
                <div class="modal__header">
                    <h2>Nuevo Reporte</h2>
                    <button id="btn-close-modal" class="btn-close">&times;</button>
                </div>
                <form id="form-report" class="card-premium" style="margin: 0;">
                    <div class="form-group" style="margin-bottom: 0.75rem;">
                        <label style="font-size:0.8rem; margin-bottom:0.25rem;">Categor铆a</label>
                        <div class="input-with-icon">
                            <i data-lucide="tag"></i>
                            <select name="category_id" id="report-category" class="input" required>
                                <option value="">Seleccionar Categor铆a</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0.75rem;">
                        <label style="font-size:0.8rem; margin-bottom:0.25rem;">Descripci贸n</label>
                        <div class="input-with-icon">
                            <i data-lucide="message-square" style="top: 0.75rem; transform: none;"></i>
                            <textarea name="description" id="report-description" class="input" style="min-height: 80px; padding-top: 0.75rem !important;" placeholder="Describe el problema aqu铆..." required></textarea>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0.75rem;">
                        <label style="font-size:0.8rem; margin-bottom:0.25rem;">Fotos (M谩x. 3)</label>
                        <div class="file-upload-container">
                            <input type="file" id="report-photos" name="photos" accept="image/*" multiple class="muni-selector">
                            <small class="text-muted">Hasta 3 archivos 路 m谩x. 30MB c/u. Tambi茅n pod茅s tomar fotos con tu c谩mara.</small>
                        </div>
                    </div>
                    <div class="form-group" style="display: flex; gap: 0.75rem; align-items: center; background: #f9fafb; padding: 0.625rem 0.875rem; border-radius: 8px; margin-bottom: 0.75rem;">
                        <i data-lucide="map-pin" style="color: var(--primary); flex-shrink: 0;"></i>
                        <span id="report-coords" style="font-size: 0.8rem; color: var(--text-muted);">Capturando ubicaci贸n...</span>
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                        <input type="checkbox" id="terms-check" required style="margin-top: 0.2rem; flex-shrink: 0;">
                        <label for="terms-check" style="font-size: 0.75rem; color: var(--text-muted); line-height: 1.35;">
                            Acepto los t茅rminos y condiciones. Entiendo que subir contenido falso, documentos inv谩lidos o censurables puede resultar en el <strong>baneo permanente</strong> de mi cuenta.
                        </label>
                    </div>
                    <button type="submit" id="btn-submit-report" class="button button--action" style="width: 100%;">Enviar Reporte</button>
                </form>
            </div>
        </div>
    
        <!-- Modal: Request Password Reset -->
        <div id="modal-reset-request" class="modal">
            <div class="modal__content">
                <div class="modal__header">
                    <h2>Recuperar Contrase帽a</h2>
                    <button id="btn-close-reset-request" class="btn-close">&times;</button>
                </div>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    Ingresa tu correo electr贸nico y te enviaremos un enlace para restablecer tu contrase帽a.
                </p>
                <form id="form-reset-request">
                    <div class="form-group">
                        <label>Correo Electr贸nico</label>
                        <input type="email" id="reset-email" class="muni-selector" placeholder="tu@email.com" required>
                    </div>
                    <button type="submit" class="btn-action">Enviar Enlace de Recuperaci贸n</button>
                </form>
            </div>
        </div>

    </div>

    <!-- Modal: XP Guide -->
    <div id="modal-xp-guide" class="modal">
        <div class="modal__content modal-xp">
            <div class="modal__header">
                <h2><i data-lucide="award"></i> Gu铆a de Experiencia</h2>
                <button id="btn-close-xp-guide" class="btn-close">&times;</button>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem; text-align: center;">
                Gana puntos de experiencia (XP) participando activamente en tu comunidad
            </p>
            <div class="xp-rewards-grid">
                <div class="xp-reward-item">
                    <div class="xp-icon" style="background: #dbeafe; color: #2563eb;">
                        <i data-lucide="edit-3"></i>
                    </div>
                    <div class="xp-info">
                        <span class="xp-action">Reportar Problema</span>
                        <span class="xp-value">+50 XP</span>
                    </div>
                </div>
                <div class="xp-reward-item">
                    <div class="xp-icon" style="background: #e0e7ff; color: #6366f1;">
                        <i data-lucide="message-square"></i>
                    </div>
                    <div class="xp-info">
                        <span class="xp-action">Comentar Solicitud</span>
                        <span class="xp-value">+10 XP</span>
                    </div>
                </div>
                <div class="xp-reward-item">
                    <div class="xp-icon" style="background: #fef3c7; color: #f59e0b;">
                        <i data-lucide="thumbs-up"></i>
                    </div>
                    <div class="xp-info">
                        <span class="xp-action">Recibir Voto til</span>
                        <span class="xp-value">+5 XP</span>
                    </div>
                </div>
                <div class="xp-reward-item">
                    <div class="xp-icon" style="background: #d1fae5; color: #059669;">
                        <i data-lucide="award"></i>
                    </div>
                    <div class="xp-info">
                        <span class="xp-action">Reporte Resuelto</span>
                        <span class="xp-value">+150 XP</span>
                    </div>
                </div>
            </div>
            <div class="xp-tip">
                <i data-lucide="lightbulb"></i>
                <p>Completa tu perfil y mant茅n una participaci贸n constante para subir de nivel m谩s r谩pido</p>
            </div>
        </div>
        </div>
    </div>

    <!-- Dynamic Modal: User Profile -->
    <div id="modal-user-profile" class="modal">
        <div class="modal__content profile-card-modal">
            <div class="modal__header">
                <h2>Perfil del Ciudadano</h2>
                <button class="button--close" onclick="document.getElementById('modal-user-profile').classList.remove('modal--active')"><i data-lucide="x"></i></button>
            </div>
            <div class="profile-card-body">
                <div class="profile-card-header">
                    <div class="profile-avatar-wrapper" id="modal-user-avatar-click">
                        <img id="modal-user-avatar" src="" alt="Avatar" class="profile-avatar-large">
                    </div>
                    <div class="profile-info-large">
                        <h3 id="modal-user-handle">@usuario</h3>
                        
                        <div class="rank-badge-container">
                            <div class="rank-icon-wrapper">
                                <i data-lucide="eye" class="rank-icon"></i>
                            </div>
                            <span id="modal-user-rank" class="rank-name">OBSERVADOR ACTIVO - NIVEL 1</span>
                        </div>
                    </div>
                </div>

                <div class="profile-stats-grid-extended">
                    <div class="stat-item-ext">
                        <span class="stat-value-ext" id="modal-user-reports">0</span>
                        <span class="stat-label-ext">REPORTES</span>
                    </div>
                    <div class="stat-item-ext">
                        <span class="stat-value-ext" id="modal-user-votes">0</span>
                        <span class="stat-label-ext">VOTOS</span>
                    </div>
                </div>

                <div class="xp-progress-section">
                    <div class="xp-progress-wrapper">
                        <div id="modal-user-xp-bar" class="xp-progress-fill-card" style="width: 0%;"></div>
                    </div>
                    <p class="xp-progress-text" id="modal-user-xp-detail">0 / 500 XP para el siguiente nivel</p>
                </div>

                <p class="profile-footer-date" id="modal-user-joined-full">Ciudadano desde el -- de -- de ----</p>

                <div class="modal-footer-actions" style="margin-top: 1.5rem;">
                    <button id="btn-view-user-reports" class="button button--orange">
                        <i data-lucide="external-link"></i> Ver sus reportes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Public Profile -->
    <div id="modal-public-profile" class="modal">
        <div class="modal__content profile-modal-compact">
            <div class="modal__header">
                <h2>Perfil del Ciudadano</h2>
                <button id="btn-close-public-profile" class="btn-close">&times;</button>
            </div>
            <div id="public-profile-content">
                <!-- Content injected via JS -->
                <div class="loading-spinner">Cargando...</div>
            </div>
        </div>
    </div>


    <!-- Modal: Update Password -->
    <div id="modal-update-password" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Nueva Contrase帽a</h2>
                <button id="btn-close-update-password" class="btn-close">&times;</button>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Ingresa tu nueva contrase帽a.
            </p>
            <form id="form-update-password">
                <div class="form-group">
                    <label>Nueva Contrase帽a</label>
                    <input type="password" id="new-password" class="muni-selector" placeholder="M铆nimo 6 caracteres" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Confirmar Contrase帽a</label>
                    <input type="password" id="confirm-password" class="muni-selector" placeholder="Repite tu contrase帽a" required minlength="6">
                </div>
                <button type="submit" class="btn-action">Actualizar Contrase帽a</button>
            </form>
        </div>
    </div>


    <!-- Lightbox Modal -->
    <div id="modal-lightbox" class="lightbox">
        <span id="btn-close-lightbox" class="lightbox-close">&times;</span>
        <img id="lightbox-img" class="lightbox-content">
        <a id="btn-download-img" class="lightbox-download" download>
            <i data-lucide="download"></i> Descargar
        </a>
    </div>




    <!-- Modal: Perfil P煤blico de Municipalidad -->
    <div id="modal-muni-profile" class="modal muni-profile-modal">
        <div class="modal__content modal-large">
            <!-- Header del perfil -->
            <div class="muni-profile-header">
                <div class="muni-profile-avatar">
                    <i data-lucide="building-2"></i>
                </div>
                <div>
                    <h2 class="muni-profile-name" id="modal-muni-nombre">Municipalidad</h2>
                    <button id="btn-close-muni-profile" class="btn-close" style="position:absolute;top:1rem;right:1rem;background:rgba(255,255,255,0.15);color:white;border:none;cursor:pointer;border-radius:50%;width:32px;height:32px;"></button>
                </div>
            </div>

            <!-- Stats principales -->
            <div class="muni-profile-stats">
                <div class="muni-stat-box">
                    <p class="muni-stat-box__value" id="muni-stat-resueltos"></p>
                    <span class="muni-stat-box__label">Resueltos</span>
                </div>
                <div class="muni-stat-box">
                    <p class="muni-stat-box__value" id="muni-stat-pendientes"></p>
                    <span class="muni-stat-box__label">Pendientes</span>
                </div>
                <div class="muni-stat-box">
                    <p class="muni-stat-box__value" id="muni-stat-tasa"></p>
                    <span class="muni-stat-box__label">Tasa Resoluci贸n</span>
                </div>
            </div>

            <!-- Secci贸n: Calificar -->
            <div class="muni-rate-section role-restricted">
                <h4><i data-lucide="star" style="width:14px;height:14px;vertical-align:middle;"></i> Tu calificaci贸n</h4>
                <div class="stars-input" id="muni-stars-input">
                    <!-- Generado din谩micamente por ranking.js -->
                </div>
                <button id="btn-submit-muni-rating" class="button button--primary" style="font-size:0.85rem;padding:0.5rem 1.25rem;">
                    Guardar calificaci贸n
                </button>
            </div>

            <!-- Secci贸n: Comentarios -->
            <div class="muni-comments-section">
                <h4><i data-lucide="message-circle" style="width:14px;height:14px;vertical-align:middle;"></i> Comentarios ciudadanos</h4>

                <!-- Formulario nuevo comentario (solo usuarios autenticados) -->
                <div class="comment-form role-restricted">
                    <textarea id="muni-comment-text" placeholder="Escribe tu opini贸n sobre esta municipalidad (m铆n. 10 caracteres)..." rows="3"></textarea>
                    <button id="btn-submit-muni-comment" class="button button--primary" style="align-self:flex-end;font-size:0.85rem;padding:0.5rem 1.25rem;">
                        <i data-lucide="send" style="width:14px;height:14px;"></i> Publicar comentario
                    </button>
                </div>

                <!-- Lista de comentarios -->
                <div id="muni-comments-list">
                    <!-- Renderizado din谩micamente por ranking.js -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Admin Municipality -->
    <div id="modal-admin-municipality" class="modal">
        <div class="modal__content modal-large">
            <div class="modal__header">
                <h2 id="modal-muni-title">Nueva Municipalidad</h2>
                <button id="btn-close-modal-muni" class="btn-close">&times;</button>
            </div>
            <div class="modal-body-split">
                <div class="modal-form-side">
                    <form id="form-muni">
                        <div class="form-group">
                            <label>Nombre de la Municipalidad</label>
                            <input type="text" id="muni-name" class="muni-selector" required>
                        </div>
                        <div class="form-group">
                            <label>Ubicaci贸n (Centro)</label>
                            <small class="text-muted">Arrastra el marcador en el mapa.</small>
                            <div class="coords-inputs">
                                <input type="text" id="muni-lat" placeholder="Latitud" readonly>
                                <input type="text" id="muni-lng" placeholder="Longitud" readonly>
                            </div>
                        </div>
                        <button type="submit" class="button button--primary" style="width: 100%; margin-top: 1rem;">
                            Guardar Municipalidad
                        </button>
                    </form>
                </div>
                <div class="modal-map-side">
                    <div id="muni-map-container" style="width: 100%; height: 100%; min-height: 300px; border-radius: 8px;"></div>
                    <div id="muni-map-loader" class="map-loader">
                        <div class="spinner"></div>
                        <p>Cargando mapa...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Admin Departments (Premium V2) -->
    <div id="modal-admin-departments" class="modal">
        <div class="modal__content" style="max-width:800px; border-radius:20px; overflow:hidden; padding:0;">
            <!-- Header Gradiente Premium (Slate para Admin) -->
            <div style="background: linear-gradient(135deg, #1e293b 0%, #334155 100%); padding: 1.75rem 1.75rem 4.5rem; position:relative;">
                <button id="btn-close-modal-dept" class="btn-close" style="position:absolute; top:1rem; right:1rem; color:white; opacity:0.8;">&times;</button>
                <div style="display:flex; align-items:center; gap:1.25rem;">
                    <div style="width:56px; height:56px; border-radius:50%; background:rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; backdrop-filter:blur(4px); border:1px solid rgba(255,255,255,0.2);">
                        <i data-lucide="settings" style="width:28px; height:28px; color:white;"></i>
                    </div>
                    <div>
                        <h2 style="color:white; font-size:1.5rem; margin:0;">Gesti贸n de Departamentos</h2>
                        <div style="display:flex; align-items:center; gap:0.5rem; margin-top:0.25rem;">
                            <i data-lucide="building-2" style="width:14px; height:14px; color:rgba(255,255,255,0.6);"></i>
                            <p style="color:rgba(255,255,255,0.7); font-size:0.9rem; margin:0;" id="modal-dept-muni-name"></p>
                        </div>
                    </div>
                </div>
                <!-- Wave separator -->
                <svg viewBox="0 0 600 40" xmlns="http://www.w3.org/2000/svg" style="position:absolute; bottom:-1px; left:0; width:100%;" preserveAspectRatio="none">
                    <path d="M0,40 C150,0 450,0 600,40 L600,40 L0,40 Z" fill="white"/>
                </svg>
            </div>
            
            <div class="modal-dept-layout" style="padding: 0.5rem 1.5rem 1.5rem;">
                <!-- New Dept Panel (Minimalist) -->
                <div class="dept-entry-panel">
                    <form id="form-add-dept" class="dept-form-minimal">
                        <div class="dept-form-grid">
                            <div class="form-group-minimal" style="margin-bottom:0.75rem;">
                                <label for="new-dept-name" style="font-size:0.7rem; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); font-weight:600;">Nombre de la Unidad</label>
                                <input type="text" id="new-dept-name" class="input-minimal" placeholder="Ej: Obras P煤blicas" required style="padding:0.6rem; background:#f8fafc;">
                            </div>
                            <div class="form-group-minimal" style="margin-bottom:0.75rem;">
                                <label for="new-dept-contact" style="font-size:0.7rem; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); font-weight:600;">Contacto / WhatsApp</label>
                                <input type="text" id="new-dept-contact" class="input-minimal" placeholder="+595 ..." style="padding:0.6rem; background:#f8fafc;">
                            </div>
                            <div class="form-group-minimal" style="margin-bottom:0.75rem;">
                                <label for="new-dept-status" style="font-size:0.7rem; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); font-weight:600;">Estado</label>
                                <select id="new-dept-status" class="input-minimal" style="padding:0.6rem; background:#f8fafc; cursor:pointer;">
                                    <option value="activo">Activo</option>
                                    <option value="inactivo">Inactivo</option>
                                </select>
                            </div>
                            <div class="dept-form-actions">
                                <button type="submit" class="button button--primary btn-save-dept" style="height:42px; width:100%; justify-content:center; border-radius:8px;">
                                    <span id="btn-submit-dept-text"><i data-lucide="plus"></i> Agregar</span>
                                </button>
                                <button type="button" id="btn-cancel-dept-edit" class="button button--secondary btn-cancel-dept" style="display: none; height:42px; width:100%; justify-content:center; border-radius:8px; margin-top:0.5rem;">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="dept-list-section">
                    <div class="toolbar-premium toolbar--minimal" style="background:#f8fafc; border-radius:12px; border:1px solid #e2e8f0; padding:0.75rem 1rem;">
                        <div class="search-premium-mini">
                            <i data-lucide="search" class="search-icon-mini"></i>
                            <input type="text" id="admin-dept-search-input" class="search-input-mini" placeholder="Filtrar departamentos...">
                        </div>
                        <div class="dept-count-badge" style="background:var(--primary); color:white; border:none;">
                            <span id="dept-count">0</span> unidades
                        </div>
                    </div>

                    <div class="table-container-minimal" style="margin-top:1rem; border:1px solid #e2e8f0; border-radius:12px; overflow:hidden;">
                        <div class="table-wrapper-scroll" style="max-height: 350px;">
                            <table class="admin-table table-minimal">
                                <thead style="background:#f1f5f9;">
                                    <tr>
                                        <th style="font-size:0.7rem; text-transform:uppercase; color:#64748b;">Unidad Organizativa</th>
                                        <th style="font-size:0.7rem; text-transform:uppercase; color:#64748b;">Contacto</th>
                                        <th style="text-align: right; font-size:0.7rem; text-transform:uppercase; color:#64748b;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-dept-list">
                                    <!-- JS populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Admin User Edit -->
    <div id="modal-admin-user" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Editar Usuario</h2>
                <button id="btn-close-modal-user" class="btn-close">&times;</button>
            </div>
            <form id="form-edit-user">
                <div class="form-group">
                    <label>Alias</label>
                    <input type="text" id="edit-user-alias" class="muni-selector">
                </div>
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" id="edit-user-fullname" class="muni-selector">
                </div>
                <div class="form-group">
                    <label>Rol</label>
                    <select id="edit-user-role" class="muni-selector">
                        <option value="ciudadano">Ciudadano</option>
                        <option value="municipal">Municipal</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nivel de Vecino</label>
                    <select id="edit-user-level" class="muni-selector">
                        <option value="Vecino Novato">Vecino Novato</option>
                        <option value="Vecino Observador">Vecino Observador</option>
                        <option value="Vecino Comprometido">Vecino Comprometido</option>
                        <option value="Vecino Experto">Vecino Experto</option>
                        <option value="L铆der Comunitario">L铆der Comunitario</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Estado de Cuenta</label>
                    <select id="edit-user-status" class="muni-selector">
                        <option value="true">Activo</option>
                        <option value="false">Baneado / Inactivo</option>
                    </select>
                </div>
                <button type="submit" class="button button--primary" style="width: 100%; margin-top: 1rem;">
                    Guardar Cambios
                </button>
            </form>
        </div>
    </div>

    <!-- Modal: Admin Reset Password -->
    <div id="modal-reset-password" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h2>Resetear Contrase帽a</h2>
                <button id="btn-close-modal-reset" class="btn-close">&times;</button>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                驴Est谩s seguro que deseas enviar un correo de restablecimiento de contrase帽a a <strong id="reset-user-email-display"></strong>?
            </p>
            <div class="modal-footer-actions">
                <button id="btn-cancel-reset" class="button button--secondary">Cancelar</button>
                <button id="btn-confirm-reset" class="button button--primary">Confirmar Env铆o</button>
            </div>
        </div>
    </div>

    <!-- Modal: Detalles Solicitud Rol -->
    <div id="modal-role-request-details" class="modal">
        <div class="modal__content" style="max-width: 580px; border-radius: 20px; overflow:hidden; padding:0;">
            <!-- Header del Modal -->
            <div style="background: linear-gradient(135deg, var(--primary) 0%, #059669 100%); padding: 1.75rem 1.75rem 4rem; position:relative;">
                <button id="btn-close-role-details" class="btn-close" style="position:absolute; top:1rem; right:1rem; color:white; opacity:0.8;">&times;</button>
                <div style="display:flex; align-items:center; gap:1rem;">
                    <div style="width:56px; height:56px; border-radius:50%; background:rgba(255,255,255,0.2); display:flex; align-items:center; justify-content:center; backdrop-filter:blur(4px);">
                        <i data-lucide="file-check" style="width:28px; height:28px; color:white;"></i>
                    </div>
                    <div>
                        <p style="color:rgba(255,255,255,0.7); font-size:0.8rem; margin-bottom:0.2rem; text-transform:uppercase; letter-spacing:0.08em;">Solicitud de Rol Municipal</p>
                        <h2 style="color:white; font-size:1.25rem; margin:0;" id="detail-user-name"></h2>
                        <p style="color:rgba(255,255,255,0.75); font-size:0.85rem; margin:0.25rem 0 0;" id="detail-user-email"></p>
                    </div>
                </div>
                <!-- Wave separator -->
                <svg viewBox="0 0 600 40" xmlns="http://www.w3.org/2000/svg" style="position:absolute; bottom:-1px; left:0; width:100%;" preserveAspectRatio="none">
                    <path d="M0,40 C150,0 450,0 600,40 L600,40 L0,40 Z" fill="white"/>
                </svg>
            </div>

            <!-- Cuerpo del Modal -->
            <div style="padding: 1.5rem 1.75rem 1.75rem; display:flex; flex-direction:column; gap:1.25rem;">

                <!-- Municipalidad -->
                <div style="display:flex; align-items:center; gap:0.75rem; padding:1rem; background:#f8fafc; border-radius:12px; border:1px solid #e2e8f0;">
                    <div style="width:36px; height:36px; border-radius:10px; background:#eff6ff; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                        <i data-lucide="building-2" style="width:18px; height:18px; color:#3b82f6;"></i>
                    </div>
                    <div>
                        <p style="font-size:0.7rem; text-transform:uppercase; letter-spacing:0.06em; color:var(--text-muted); margin:0 0 0.1rem;">Municipalidad Solicitada</p>
                        <p style="font-weight:600; color:var(--text-main); margin:0;" id="detail-muni-name"></p>
                    </div>
                </div>

                <!-- Comentario del Usuario -->
                <div>
                    <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
                        <i data-lucide="message-square" style="width:14px; height:14px; color:var(--text-muted);"></i>
                        <span style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); font-weight:600;">Comentario del Usuario</span>
                    </div>
                    <div id="detail-user-comment" style="background:#f8fafc; border:1px solid #e2e8f0; border-left:3px solid var(--primary); border-radius:0 10px 10px 0; padding:1rem; font-size:0.9rem; line-height:1.6; color:var(--text-main); min-height:60px;"></div>
                </div>

                <!-- Documento Adjunto -->
                <div>
                    <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
                        <i data-lucide="paperclip" style="width:14px; height:14px; color:var(--text-muted);"></i>
                        <span style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); font-weight:600;">Documento de Verificaci贸n</span>
                    </div>
                    <a id="detail-doc-link" href="#" target="_blank" class="button button--secondary" style="display:flex; align-items:center; justify-content:center; gap:0.5rem; text-decoration:none;">
                        <i data-lucide="external-link" style="width:16px; height:16px;"></i> Abrir Documento Adjunto
                    </a>
                </div>

                <!-- Zona de Acciones -->
                <div id="action-area-pending" style="border-top: 1px solid #e2e8f0; padding-top:1.25rem;">
                    <p style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); font-weight:600; margin-bottom:0.75rem;">Acci贸n Administrativa</p>
                    <div style="display:flex; gap:0.75rem;">
                        <button id="btn-modal-approve" class="button button--primary" style="flex:1; display:flex; align-items:center; justify-content:center; gap:0.5rem; padding:0.75rem;">
                            <i data-lucide="check-circle" style="width:18px;height:18px;"></i> Aprobar Solicitud
                        </button>
                        <button id="btn-modal-reject" class="button button--danger" style="display:flex; align-items:center; justify-content:center; gap:0.5rem; padding:0.75rem 1.25rem; background:transparent; border:2px solid #dc2626; color:#dc2626;">
                            <i data-lucide="x-circle" style="width:18px;height:18px;"></i> Rechazar
                        </button>
                    </div>
                </div>

                <!-- Zona de Motivo de Rechazo -->
                <div id="rejection-reason-area" class="hidden" style="border-top:1px solid #e2e8f0; padding-top:1.25rem;">
                    <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
                        <i data-lucide="alert-triangle" style="width:14px; height:14px; color:#dc2626;"></i>
                        <span style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.07em; color:#dc2626; font-weight:600;">Motivo del Rechazo (Obligatorio)</span>
                    </div>
                    <textarea id="input-rejection-reason" class="input" rows="3" style="width:100%; resize:none; border-color:#fca5a5;" placeholder="Explica claramente por qu茅 se rechaza la solicitud..."></textarea>
                    <div style="display:flex; gap:0.75rem; margin-top:0.75rem;">
                        <button id="btn-confirm-reject" class="button button--danger" style="flex:1;">Confirmar Rechazo</button>
                        <button id="btn-cancel-reject" class="button button--secondary" style="padding:0.75rem 1.25rem;">Cancelar</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal: Gesti贸n de Reporte Municipal (Premium V2) -->
    <div id="modal-gestion-reporte" class="modal" style="display:none;">
        <div class="modal__content" style="max-width:680px; border-radius:20px; overflow:hidden; padding:0; max-height:90vh; overflow-y:auto;">

            <!-- Header Gradiente Premium -->
            <div style="background: linear-gradient(135deg, #0f766e 0%, var(--primary) 100%); padding: 1.5rem 1.75rem 4rem; position:relative; flex-shrink:0;">
                <button id="btn-mgestion-cerrar" class="btn-close" style="position:absolute; top:1rem; right:1rem; color:white; opacity:0.8;">&times;</button>
                <div style="display:flex; align-items:center; gap:1rem;">
                    <div style="width:52px; height:52px; border-radius:50%; background:rgba(255,255,255,0.2); display:flex; align-items:center; justify-content:center; backdrop-filter:blur(4px);">
                        <i data-lucide="clipboard-edit" style="width:26px; height:26px; color:white;"></i>
                    </div>
                    <div>
                        <p style="color:rgba(255,255,255,0.75); font-size:0.75rem; text-transform:uppercase; letter-spacing:0.08em; margin-bottom:0.2rem;">Gesti贸n Municipal</p>
                        <h2 style="color:white; font-size:1.25rem; margin:0;" id="mgestion-numero"></h2>
                    </div>
                    <div style="margin-left:auto; display:flex; align-items:center; gap:0.75rem;">
                        <a id="btn-mgestion-gps" class="button button--secondary" 
                           style="display:none; background:rgba(255,255,255,0.2); color:white; border:none; padding:0.4rem 1rem; border-radius:999px; font-size:0.75rem; font-weight:600; backdrop-filter:blur(4px); text-decoration:none; align-items:center; gap:0.4rem; white-space:nowrap;" 
                           target="_blank">
                            <i data-lucide="navigation" style="width:14px;height:14px;"></i> Ir al lugar
                        </a>
                        <span id="mgestion-estado-badge"
                              style="background:rgba(255,255,255,0.2); color:white;
                                     padding:0.35rem 0.85rem; border-radius:999px; font-size:0.8rem; font-weight:600; backdrop-filter:blur(4px);"></span>
                    </div>
                </div>
                <!-- Wave separator -->
                <svg viewBox="0 0 600 40" xmlns="http://www.w3.org/2000/svg"
                     style="position:absolute; bottom:-1px; left:0; width:100%;" preserveAspectRatio="none">
                    <path d="M0,40 C150,0 450,0 600,40 L600,40 L0,40 Z" fill="white"/>
                </svg>
            </div>

            <!-- Cuerpo -->
            <div style="padding: 1.5rem 1.75rem 1.75rem; display:flex; flex-direction:column; gap:1.25rem;">

                <!-- Info del Ciudadano -->
                <div style="display:flex; gap:1rem; align-items:center; padding:1rem; background:#f8fafc; border-radius:12px; border:1px solid #e2e8f0;">
                    <div style="width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg, var(--primary), #059669);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                        <i data-lucide="user" style="width:18px;height:18px;color:white;"></i>
                    </div>
                    <div>
                        <p style="font-weight:600; margin:0; color:var(--text-main);" id="mgestion-ciudadano"></p>
                        <p style="font-size:0.8rem; color:var(--text-muted); margin:0;" id="mgestion-email"></p>
                    </div>
                    <div style="margin-left:auto; text-align:right;">
                        <p style="font-size:0.75rem; color:var(--text-muted); margin:0;">Creado</p>
                        <p style="font-size:0.8rem; font-weight:600; color:var(--text-main); margin:0;" id="mgestion-fecha-creacion"></p>
                    </div>
                </div>

                <!-- Descripci贸n y Categor铆a -->
                <div>
                    <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">
                        <i data-lucide="file-text" style="width:14px;height:14px;color:var(--text-muted);"></i>
                        <span style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); font-weight:600;">Descripci贸n</span>
                        <span style="margin-left:auto; font-size:0.75rem; color:var(--primary); font-weight:600; display:flex; align-items:center; gap:0.3rem;">
                            <i data-lucide="tag" style="width:12px;height:12px;"></i>
                            <span id="mgestion-categoria"></span>
                        </span>
                    </div>
                    <div id="mgestion-descripcion"
                         style="background:#f8fafc; border:1px solid #e2e8f0; border-left:3px solid #0f766e;
                                border-radius:0 10px 10px 0; padding:1rem; font-size:0.9rem; line-height:1.6; color:var(--text-main);"></div>
                </div>

                <!-- Asignaci贸n de Departamentos (m煤ltiple) -->
                <div>
                    <label style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); font-weight:600; display:flex; align-items:center; gap:0.4rem; margin-bottom:0.5rem;">
                        <i data-lucide="git-branch" style="width:13px;height:13px;"></i>
                        Departamentos Asignados
                    </label>
                    
                    <!-- Filtro de departamentos -->
                    <div style="position:relative; margin-bottom:0.5rem;">
                        <i data-lucide="search" style="position:absolute; left:0.75rem; top:50%; transform:translateY(-50%); width:14px; height:14px; color:var(--text-muted);"></i>
                        <input type="text" id="mgestion-depto-filtro" placeholder="Buscar departamento para asignar..." 
                               style="width:100%; padding:0.5rem 0.75rem 0.5rem 2.25rem; border-radius:8px; border:1px solid #e2e8f0; font-size:0.85rem; background:white; outline:none;"
                               autocomplete="off">
                    </div>

                    <!-- Renderizado din谩mico via JS -->
                    <div id="mgestion-departamentos-lista"
                         style="display:flex; flex-direction:column; gap:0.5rem; padding:0.75rem;
                                border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc; min-height:48px;">
                        <span style="font-size:0.82rem; color:var(--text-muted);">Cargando departamentos...</span>
                    </div>
                    <p style="font-size:0.75rem; color:var(--text-muted); margin:0.4rem 0 0; display:flex; align-items:center; gap:0.3rem;">
                        <i data-lucide="clock" style="width:11px;height:11px;"></i>
                        Primera asignaci贸n: <strong id="mgestion-fecha-asignacion">Pendiente</strong>
                    </p>
                </div>

                <!-- Prioridad de Gesti贸n -->
                <div>
                    <label style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); font-weight:600; display:flex; align-items:center; gap:0.4rem; margin-bottom:0.5rem;">
                        <i data-lucide="alert-triangle" style="width:13px;height:13px;"></i>
                        Prioridad de Gesti贸n
                    </label>
                    <select id="mgestion-prioridad" class="input">
                        <option value="baja"> Baja</option>
                        <option value="media" selected> Media</option>
                        <option value="alta"> Alta</option>
                        <option value="urgente"> Urgente</option>
                    </select>
                </div>

                <!-- Estado -->
                <div>
                    <label style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); font-weight:600; display:flex; align-items:center; gap:0.4rem; margin-bottom:0.5rem;">
                        <i data-lucide="activity" style="width:13px;height:13px;"></i>
                        Cambiar Estado
                    </label>
                    <select id="mgestion-estado" class="input">
                        <option value="Pendiente">Pendiente</option>
                        <option value="En proceso">En proceso</option>
                        <option value="Resuelto">Resuelto</option>
                        <option value="Rechazado">Rechazado</option>
                    </select>
                </div>

                <!-- Observaci贸n del Funcionario -->
                <div>
                    <label style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); font-weight:600; display:flex; align-items:center; gap:0.4rem; margin-bottom:0.5rem;">
                        <i data-lucide="message-circle" style="width:13px;height:13px;"></i>
                        Observaci贸n del Funcionario <span style="font-weight:400;">(opcional)</span>
                    </label>
                    <textarea id="mgestion-observacion" class="input" rows="2"
                              placeholder="Ingrese notas internas sobre la gesti贸n..."
                              style="resize:vertical; font-size:0.9rem;"></textarea>
                </div>

                <!-- Zona de Cierre: Solo se muestra si el estado es Resuelto o Rechazado -->
                <div id="mgestion-zona-cierre" style="display:none;">
                    <div style="background:#fef3c7; border:1px solid #f59e0b; border-radius:10px; padding:0.75rem 1rem; margin-bottom:0.75rem; display:flex; align-items:center; gap:0.6rem;">
                        <i data-lucide="alert-triangle" style="width:16px;height:16px;color:#d97706;flex-shrink:0;"></i>
                        <p style="margin:0; font-size:0.82rem; color:#92400e;">
                            Para cerrar esta solicitud debes adjuntar <strong>al menos una evidencia</strong> fotogr谩fica de la resoluci贸n o rechazo.
                        </p>
                    </div>

                    <label style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); font-weight:600; display:flex; align-items:center; gap:0.4rem; margin-bottom:0.5rem;">
                        <i data-lucide="paperclip" style="width:13px;height:13px;"></i>
                        Evidencias de Cierre <span style="color:#ef4444;">*</span>
                    </label>

                    <!-- Dropzone -->
                    <div id="mgestion-dropzone"
                         style="border:2px dashed #d1d5db; border-radius:12px; padding:1.5rem; text-align:center;
                                cursor:pointer; transition:border-color 0.2s; background:#fafafa;">
                        <i data-lucide="upload-cloud" style="width:28px;height:28px;color:var(--text-muted);margin-bottom:0.35rem;"></i>
                        <p style="margin:0; font-size:0.85rem; color:var(--text-muted);">Arrastra im谩genes aqu铆 o <strong style="color:var(--primary);">haz clic para seleccionar</strong></p>
                        <p style="margin:0.25rem 0 0; font-size:0.75rem; color:var(--text-muted);">PNG, JPG o WEBP 路 M谩ximo 5 archivos</p>
                        <input type="file" id="mgestion-evidencias" accept="image/*" multiple style="display:none;">
                    </div>
                    <div id="mgestion-evidencias-preview" style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.5rem;"></div>
                </div>

                <!-- Bot贸n Guardar -->
                <button id="btn-mgestion-guardar" class="button button--primary"
                        style="width:100%; padding:0.85rem; display:flex; align-items:center; justify-content:center; gap:0.5rem; font-size:0.95rem;">
                    <i data-lucide="save" style="width:18px;height:18px;"></i>
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Gesti贸n de Departamento (Premium V2) -->
    <div id="modal-muni-departamento" class="modal">
        <div class="modal__content" style="max-width:550px; border-radius:20px; overflow:hidden; padding:0;">
            <!-- Header Gradiente Premium -->
            <div style="background: linear-gradient(135deg, #0f766e 0%, var(--primary) 100%); padding: 1.75rem 1.75rem 4rem; position:relative;">
                <button id="btn-muni-dept-cerrar" class="btn-close" style="position:absolute; top:1rem; right:1rem; color:white; opacity:0.8;">&times;</button>
                <div style="display:flex; align-items:center; gap:1rem;">
                    <div style="width:52px; height:52px; border-radius:50%; background:rgba(255,255,255,0.2); display:flex; align-items:center; justify-content:center; backdrop-filter:blur(4px);">
                        <i data-lucide="building-2" style="width:26px; height:26px; color:white;"></i>
                    </div>
                    <div>
                        <p style="color:rgba(255,255,255,0.75); font-size:0.75rem; text-transform:uppercase; letter-spacing:0.08em; margin-bottom:0.2rem;">Gesti贸n de rea</p>
                        <h2 style="color:white; font-size:1.25rem; margin:0;" id="modal-muni-dept-title">Nuevo Departamento</h2>
                    </div>
                </div>
                <!-- Wave separator -->
                <svg viewBox="0 0 600 40" xmlns="http://www.w3.org/2000/svg" style="position:absolute; bottom:-1px; left:0; width:100%;" preserveAspectRatio="none">
                    <path d="M0,40 C150,0 450,0 600,40 L600,40 L0,40 Z" fill="white"/>
                </svg>
            </div>

            <!-- Cuerpo del Modal -->
            <div style="padding: 1.5rem 1.75rem 2rem; display:flex; flex-direction:column; gap:1.5rem;">
                <form id="form-muni-dept" class="form-standard">
                    <input type="hidden" id="muni-dept-id">
                    
                    <div style="display: flex; flex-direction: column; gap: 1.25rem;">
                        <div class="form-group">
                            <label style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); font-weight:600; display:flex; align-items:center; gap:0.4rem; margin-bottom:0.5rem;">
                                <i data-lucide="tag" style="width:13px;height:13px;"></i> Nombre del Departamento
                            </label>
                            <div class="input-with-icon">
                                <i data-lucide="building"></i>
                                <input type="text" id="muni-dept-nombre" class="input" required placeholder="Ej: Obras P煤blicas, Tr谩nsito...">
                            </div>
                        </div>

                        <div class="form-group">
                            <label style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); font-weight:600; display:flex; align-items:center; gap:0.4rem; margin-bottom:0.5rem;">
                                <i data-lucide="phone" style="width:13px;height:13px;"></i> Contacto / Informaci贸n
                            </label>
                            <div class="input-with-icon">
                                <i data-lucide="message-circle"></i>
                                <input type="text" id="muni-dept-contacto" class="input" placeholder="Tel茅fono, email o encargado...">
                            </div>
                        </div>

                        <div class="form-group">
                            <label style="font-size:0.75rem; text-transform:uppercase; letter-spacing:0.07em; color:var(--text-muted); font-weight:600; display:flex; align-items:center; gap:0.4rem; margin-bottom:0.5rem;">
                                <i data-lucide="activity" style="width:13px;height:13px;"></i> Estado Inicial
                            </label>
                            <div class="input-with-icon">
                                <i data-lucide="refresh-ccw"></i>
                                <select id="muni-dept-estado" class="input">
                                    <option value="activo">Activo</option>
                                    <option value="inactivo">Inactivo</option>
                                </select>
                            </div>
                            <small class="text-muted" style="display: block; margin-top: 0.5rem; font-size: 0.75rem;">
                                <i data-lucide="info" style="width: 12px; height: 12px; vertical-align: middle;"></i>
                                Los departamentos inactivos no podr谩n ser asignados a nuevos reportes.
                            </small>
                        </div>
                    </div>

                    <div style="margin-top: 2rem;">
                        <button type="submit" id="btn-muni-dept-guardar" class="button button--primary" style="width:100%; height:52px; display:flex; align-items:center; justify-content:center; gap:0.75rem; font-weight:600; border-radius:12px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);">
                            <i data-lucide="save"></i> Guardar Departamento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Custom Toasts -->

    <div id="toast-container" class="toast-container"></div>

    <!-- Templates -->
    <template id="tpl-report-card">
        <div class="report-card">
            <div class="report-card__header">
                 <span class="report-card__id"></span>
                 <span class="report-card__category"></span>
                 <span class="status-badge"></span>
            </div>
            <p class="report-card__description"></p>

            <div class="report-card__stats">
                 <div class="report-card__author js-view-profile" title="Ver perfil del ciudadano">
                    <i data-lucide="user"></i> Ver Ciudadano
                </div>

                <div class="report-card__priority" title="Prioridad">
                     <div class="priority-stars"></div>
                </div>

                <div class="report-card__stat stat-votes" title="Apoyos">
                    <i data-lucide="thumbs-up"></i> <span></span>
                </div>

                <div class="report-card__stat stat-comments" title="Comentarios">
                    <i data-lucide="message-square"></i> <span></span>
                </div>
            </div>

            <div class="report-card__meta">
                <span class="report-card__location"><i data-lucide="map-pin"></i> <span></span></span>
                <span class="report-card__date"></span>
            </div>
        </div>
    </template>

    <!-- Modal: Confirmaci贸n Personalizado -->
    <div id="modal-confirm" class="modal">
        <div class="modal__content modal-confirm-content" style="max-width: 400px; text-align: center; border-radius: 20px; padding: 2rem;">
            <div style="width: 60px; height: 60px; background: #fef3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                <i data-lucide="alert-triangle" style="width: 30px; height: 30px; color: #f59e0b;"></i>
            </div>
            <h3 id="modal-confirm-title" style="margin-bottom: 0.5rem; font-size: 1.25rem;">驴Est谩s seguro?</h3>
            <p id="modal-confirm-message" style="color: var(--text-muted); margin-bottom: 2rem; font-size: 0.95rem;">
                Esta acci贸n no se puede deshacer.
            </p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button id="btn-confirm-cancel" class="button button--secondary" style="flex: 1;">Cancelar</button>
                <button id="btn-confirm-ok" class="button button--primary" style="flex: 1;">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Defer loading of non-critical libraries -->
    <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Main Application Script (Modular) -->
    <script type="module" src="src/modules/admin-view-connector.js"></script>
    <script type="module" src="src/main.js"></script>
</body>
</html>
